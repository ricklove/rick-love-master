(window.__LOADABLE_LOADED_CHUNKS__=window.__LOADABLE_LOADED_CHUNKS__||[]).push([[20],{RTBV:function(e,t,n){"use strict";n.r(t),n.d(t,"DoodlePartyView",(function(){return k})),n.d(t,"DoodlePartyView_Inner",(function(){return C}));var r=n("ERkP"),a=n.n(r),l=n("DTYs"),i=n("t8gp");function o(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return c(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return c(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0;return function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(n=e[Symbol.iterator]()).next.bind(n)}function c(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var s=n("hEsX"),u=n("C2Qu"),m=n("+tC1"),y=n("4cHy"),d=function(){return{clientStorage:{load:function(){try{var e;return JSON.parse(null!==(e=localStorage.getItem("_DoodleGameClient"))&&void 0!==e?e:"NULL!{}")}catch(t){return null}},save:function(e){localStorage.setItem("_DoodleGameClient",JSON.stringify(e))}}}},f=function(){var e,t=function(e){for(var t,n={},r=o(("?"===e[0]?e.substr(1):e).split("&"));!(t=r()).done;){var a=t.value.split("=");n[decodeURIComponent(a[0])]=decodeURIComponent(a[1]||"")}return n}(window.location.search);return{client:{_query:t,room:(e=t.room,null!=e?e:"UnknownRoom"),role:function(e){switch(e){case"debug":return"debug";case"viewer":return"viewer";default:return"player"}}(t.role),clientPlayer:{clientKey:(""+Math.random()).substr(2),name:"",emoji:"👤",isReady:!1}},players:[],history:{rounds:[]}}},p=function(){var e=Object(r.useRef)(f()).current,t=e.client.clientPlayer.clientKey,n=Object(r.useState)(!0),a=n[0],l=n[1],o=Object(r.useState)(0),c=o[0],p=o[1],g=function(){p((function(e){return e+1}))},E=Object(r.useState)([]),v=E[0],b=E[1],h=Object(r.useState)([]),S=h[0],w=h[1],j=Object(r.useRef)(null),F=Object(r.useRef)(null);Object(r.useEffect)((function(){var t;(t=d().clientStorage.load())&&(e.client.clientPlayer={clientKey:t.clientPlayer.clientKey,name:t.clientPlayer.name,emoji:t.clientPlayer.emoji,isReady:!1,isUser:!0}),g();var n=Object(s.a)({websocketsApiUrl:u.a.websocketsApiUrl}).connect({key:e.client.room}),r=n.subscribeMessages((function(t){F.current||(F.current=function(e,t,n){console.log("createMessageHandler");var r=e.client.clientPlayer.clientKey,a=setTimeout((function(){})),l=function(t){e.masterClientKey=r,n({kind:"syncResponse",requestedClientKey:t,gameState:{masterClientKey:e.masterClientKey,players:e.players,history:e.history},clientKey:r,timestamp:Date.now()})},o={startTimestamp:Date.now(),clientStates:{}},c=function(){if(!e.players.some((function(e){return!e.isReady||e.assignment&&(!e.assignment.doodle||!e.assignment.prompt)}))){var t={completed:Object(i.a)(e.players.map((function(e){return Object.assign({},e,{assignment:e.assignment?Object.assign({},e.assignment):void 0})})))};e.history.rounds.push(t);for(var a=e.players.map((function(e){return e.assignment})),l=0;l<e.players.length;l++){var o=l<e.players.length-1?l+1:0,c=a[l];if(c){var s=Object.assign({},c);"doodle"===s.kind?(s.kind="describe",s.prompt=void 0):(s.kind="doodle",s.doodle=void 0),e.players[o].assignment=s}else e.players[o].assignment={kind:"doodle",prompt:"Choose Your Own Word"}}n({kind:"assign",players:e.players,lastRound:t,clientKey:r,timestamp:Date.now()})}};setInterval((function(){var t,a,i=null!==(t=o.clientStates[null!==(a=e.masterClientKey)&&void 0!==a?a:""])&&void 0!==t?t:{lastMessageTimestamp:o.startTimestamp};e.masterClientKey===r?(c(),Date.now()>15e3+i.lastMessageTimestamp&&n({kind:"aliveResponse",clientKey:r,timestamp:Date.now()}),Object(m.b)(o.clientStates).filter((function(e){return e.key!==r})).filter((function(e){return Date.now()>15e3+e.value.lastMessageTimestamp})).map((function(e){return n({kind:"aliveRequest",requestedClientKey:e.key,clientKey:r,timestamp:Date.now()})})),Object(m.b)(o.clientStates).filter((function(e){return e.key!==r})).filter((function(e){return Date.now()>3e4+e.value.lastMessageTimestamp})).map((function(e){return n({kind:"dropPlayer",droppedClientKey:e.key,clientKey:r,timestamp:Date.now()})}))):Date.now()>3e4+i.lastMessageTimestamp&&(console.log("createMessageHandler - Master not responsive!",{m:i,masterState:o}),l(r))}),3e3+Object(y.a)(3e3));return{handleMessage:function(s){if(o.clientStates[s.clientKey]={lastMessageTimestamp:Date.now()},"setPlayer"===s.kind){var u=e.players.find((function(e){return e.clientKey===s.clientPlayer.clientKey}));return u||(u=Object.assign({},s.clientPlayer),e.players.push(u)),u.isUser=u.clientKey===r,u.name=s.clientPlayer.name,u.emoji=s.clientPlayer.emoji,u.isReady=s.clientPlayer.isReady,r===e.masterClientKey&&setTimeout((function(){c()}),3e3),void t()}if("dropPlayer"===s.kind)return e.players=e.players.filter((function(e){return e.clientKey!==s.droppedClientKey})),console.log("dropPlayer",{players_after:Object(i.a)(e.players),message:s}),void t();if(s.clientKey!==r){if("assign"===s.kind)return e.players=s.players,e.history.rounds.push(s.lastRound),void t();if("completeAssignment"===s.kind){var m,d=null===(m=e.players.find((function(e){return e.clientKey===s.clientKey})))||void 0===m?void 0:m.assignment;if(!d)return;return d.prompt=s.playerAssignment.prompt,d.doodle=s.playerAssignment.doodle,r===e.masterClientKey&&c(),void t()}if("aliveRequest"!==s.kind){if("syncRequest"===s.kind){if(e.masterClientKey===r)return void l(s.clientKey);clearTimeout(a),a=setTimeout((function(){l(s.clientKey)}),1e3+Object(y.a)(3e3))}if("syncResponse"===s.kind){if(clearTimeout(a),s.requestedClientKey!==r){if(s.gameState.players.length<e.players.length||s.gameState.history.rounds.length<e.history.rounds.length)return l(s.clientKey),void l(s.requestedClientKey);e.masterClientKey=s.gameState.masterClientKey}var f=e.client;Object.assign(e,s.gameState),e.client=f,e.players.forEach((function(e){e.isUser=!1}));var p=e.players.find((function(e){return e.clientKey===f.clientPlayer.clientKey}));p&&(p.isUser=!0)}}else{if(s.requestedClientKey!==r)return;n({kind:"aliveResponse",clientKey:r,timestamp:Date.now()})}}}}}(e,g,(function(e){var t;return null===(t=j.current)||void 0===t?void 0:t.call(j,e)}))),F.current.handleMessage(t),b((function(e){return[].concat(Object(i.a)(e),[Object.assign({},t,{receivedAtTimestamp:Date.now()})])}))})),a=n.subscribeConnectionEvents((function(e){j.current=n.isConnected()?n.send:null,w((function(t){return[].concat(Object(i.a)(t),[e])}))}));return l(!1),function(){j.current=null,r.unsubscribe(),a.unsubscribe()}}),[]);var O=function(){var n;"player"===e.client.role&&(null===(n=j.current)||void 0===n||n.call(j,{kind:"setPlayer",clientPlayer:e.client.clientPlayer,clientKey:t,timestamp:Date.now()}))};return Object(r.useEffect)((function(){var e;j.current&&(O(),null===(e=j.current)||void 0===e||e.call(j,{kind:"syncRequest",clientKey:t,timestamp:Date.now()}))}),[j.current]),{loading:a,renderId:c,gameState:e,setClientPlayer:function(t){console.log("useDoodlePartyController.setClientPlayer",{value:t,send:j.current});var n=d().clientStorage;e.client.clientPlayer=Object.assign({},e.client.clientPlayer,t),n.save({clientPlayer:e.client.clientPlayer}),O(),g()},sendAssignment:function(n){var r;"player"===e.client.role&&(null===(r=j.current)||void 0===r||r.call(j,{kind:"completeAssignment",playerAssignment:Object.assign({},n,{clientKey:t}),clientKey:t,timestamp:Date.now()}))},_messages:v,_events:S}},g=n("bQih"),E=function(e){var t=e.controller.gameState.client.clientPlayer,n=Object(r.useState)(Object.assign({},t)),l=n[0],i=n[1],o=Object(r.useState)(e.controller.gameState.players.filter((function(e){return!e.isUser})).map((function(e){return e.emoji}))),c=o[0],s=o[1];return Object(r.useEffect)((function(){s(e.controller.gameState.players.filter((function(e){return!e.isUser})).map((function(e){return e.emoji})))}),[e.controller.renderId]),a.a.createElement(a.a.Fragment,null,a.a.createElement(g.a.View_Panel,null,a.a.createElement(g.a.Text_FormTitle,null,"User"),a.a.createElement(h,{userProfile:l,onUserProfileChange:function(t){i(t),e.controller.setClientPlayer(Object.assign({},t,{isReady:!1}))},usedEmojis:c}),a.a.createElement(g.a.View_FormActionRow,null,a.a.createElement(g.a.Button_FormAction,{onPress:function(){e.controller.setClientPlayer(Object.assign({},t,{isReady:!0})),e.onDone()}},"Ready"))),a.a.createElement(v,e))},v=function(e){return a.a.createElement(a.a.Fragment,null,a.a.createElement(l.h,null,e.controller.gameState.players.map((function(e){return a.a.createElement(l.h,{key:e.clientKey,style:{flexDirection:"row",alignItems:"center"}},a.a.createElement(l.h,null,a.a.createElement(l.e,{style:{fontSize:24}},(t=e).isReady?t.assignment&&t.assignment&&!t.assignment.doodle&&"doodle"===t.assignment.kind?"🎨":t.assignment&&t.assignment&&!t.assignment.prompt&&"describe"===t.assignment.kind?"✏":"✔":"◻")),a.a.createElement(l.h,{style:{width:48}},a.a.createElement(l.e,{style:{fontSize:32}},e.emoji)),a.a.createElement(l.h,null,a.a.createElement(l.e,{style:{fontSize:16}},e.name)));var t}))))},b="\n🐵 🐶 🐺 🐱 🦁 🐯 🦒 🦊 🦝 🐮 🐷 🐗 🐭 🐹 🐰 🐻 🐨 🐼 🐸 🦓 🐴 🦄 🐔 🐲 \n🤖 👽 👻 🍕 🍔 🌭 🥓 🌮 🍖 🥩 🍦 🍩 🍰 🧁 🥝 🥥 🍒 🍓 🍄 🥦 🥑 🥕 \n🚗 🚑 🚒 🚜 🦼 🚲 🚂 🛩 🚀 🛸 🛰 🪐 🧯 🧷  🪑 🛎 ☂ ⛄\n".replace(/\n/g,"").split(" ").map((function(e){return e.trim()})).filter((function(e){return e})),h=function(e){var t=e.userProfile,n=e.onUserProfileChange,i=e.usedEmojis,o=Object(r.useState)(b),c=o[0],s=o[1],u=Object(r.useState)(!1),m=u[0],y=u[1];return Object(r.useEffect)((function(){s(b.filter((function(e){return!i.includes(e)})))}),[i]),m?a.a.createElement(a.a.Fragment,null,a.a.createElement(g.a.View_Form,null,a.a.createElement(l.h,{style:{flexDirection:"row",flexWrap:"wrap"}},c.map((function(e){return a.a.createElement(l.g,{key:e,onPress:function(){return r=e,y(!1),void n(Object.assign({},t,{emoji:r}));var r}},a.a.createElement(l.h,null,a.a.createElement(l.e,{style:{fontSize:32}},e)))}))))):a.a.createElement(a.a.Fragment,null,a.a.createElement(g.a.View_Form,null,a.a.createElement(g.a.View_FieldRow,null,a.a.createElement(l.g,{onPress:function(){return y(!0)}},a.a.createElement(l.h,null,a.a.createElement(l.e,{style:{fontSize:32}},t.emoji))),a.a.createElement(S,{userProfile:t,onNameChange:function(e){return n(Object.assign({},t,{name:e}))}}))))},S=function(e){var t=e.userProfile,n=e.onNameChange,l=Object(r.useState)(t.name||"Player"),i=l[0],o=l[1],c=Object(r.useState)(!1),s=c[0],u=c[1],m=function(){n(i),u(!1)};return a.a.createElement(a.a.Fragment,null,a.a.createElement(g.a.Input_Text,{value:i,onChange:o,onSubmit:m,onFocus:function(){o(""),u(!0)}}),s&&a.a.createElement(g.a.Button_FieldInline,{onPress:m},"Set Name"))},w=n("DufX"),j=n("MWkW"),F=n("pAyS"),O=function(e){var t=e.controller.gameState,n=t.client,r=n.clientPlayer,i=n.role;return a.a.createElement(a.a.Fragment,null,a.a.createElement(l.h,{key:r.clientKey,style:{padding:4,flexDirection:"row",alignItems:"center"}},"player"===i&&r?a.a.createElement(a.a.Fragment,null,a.a.createElement(l.h,{style:{width:36}},a.a.createElement(l.e,{style:{fontSize:24}},r.emoji)),a.a.createElement(l.h,null,a.a.createElement(l.e,{style:{fontSize:16}},r.name))):a.a.createElement(a.a.Fragment,null,a.a.createElement(l.h,null,a.a.createElement(l.e,{style:{fontSize:16}},i))),a.a.createElement(l.h,{style:{flex:1}}),a.a.createElement(l.h,null,a.a.createElement(l.e,{style:{fontSize:16}},t.masterClientKey===t.client.clientPlayer.clientKey?"🟢":""))))},K=function(e){return a.a.createElement(l.h,null,a.a.createElement(l.e,null,"Players"),a.a.createElement(v,{controller:e.controller}),a.a.createElement(l.e,null,"Rounds"),a.a.createElement(l.e,null,""+e.controller.gameState.history.rounds.length),e.controller.gameState.history.rounds.map((function(e,t){return a.a.createElement(l.h,{key:""+t,style:{flexDirection:"row",alignItems:"center"}},e.completed.map((function(e){return a.a.createElement(P,{key:e.clientKey,player:e})})))})))},P=function(e){var t,n=e.player,r=e.player.assignment;return a.a.createElement(l.h,{style:{flexDirection:"column",alignItems:"center"}},a.a.createElement(l.e,null,n.name),a.a.createElement(l.e,null,n.emoji),!!(null==r?void 0:r.doodle)&&a.a.createElement(F.DoodleDisplayView,{style:{width:104,height:104,color:"#FFFFFF",backgroundColor:"#000000"},drawing:Object(j.a)(r.doodle),shouldAnimate:!0,enableRedraw:!0}),a.a.createElement(l.e,null,null!==(t=null==r?void 0:r.prompt)&&void 0!==t?t:""))},D=function(e){var t,n,i=e.controller.gameState,o=i.client.clientPlayer.clientKey,c=null===(t=i.players.find((function(e){return e.clientKey===o})))||void 0===t?void 0:t.assignment,s=Object(r.useState)(""),u=s[0],m=s[1];if(Object(r.useEffect)((function(){m("")}),[c]),!c)return a.a.createElement(a.a.Fragment,null,a.a.createElement(l.h,{style:{padding:8}},a.a.createElement(l.e,null,"Please Wait Until Next Round")),a.a.createElement(K,{controller:e.controller}));if("describe"===c.kind&&c.doodle){var y=function(){c.prompt=u,e.controller.sendAssignment(c)};return a.a.createElement(a.a.Fragment,null,a.a.createElement(l.h,{style:{flexDirection:"column",alignItems:"center"}},a.a.createElement(l.e,{style:{fontSize:20,margin:8}},"Describe"),a.a.createElement(F.DoodleDisplayView,{style:{width:312,height:312,color:"#FFFFFF",backgroundColor:"#000000"},drawing:Object(j.a)(c.doodle),shouldAnimate:!0,enableRedraw:!0}),!c.prompt&&a.a.createElement(a.a.Fragment,null,a.a.createElement(l.e,{style:{fontSize:20,margin:8,color:"#FFFF00"}},"What is this?"),a.a.createElement(g.a.Input_Text,{value:u,onChange:m,onSubmit:y}),a.a.createElement(g.a.Button_FieldInline,{onPress:y},"Done")),c.prompt&&a.a.createElement(l.e,{style:{fontSize:20,margin:8,color:"#FFFF00"}},c.prompt)))}return c.doodle?a.a.createElement(a.a.Fragment,null,a.a.createElement(l.h,{style:{flexDirection:"column",alignItems:"center"}},a.a.createElement(l.e,{style:{fontSize:20,margin:8}},"Draw"),a.a.createElement(F.DoodleDisplayView,{style:{width:312,height:312,color:"#FFFFFF",backgroundColor:"#000000"},drawing:Object(j.a)(c.doodle),shouldAnimate:!0,enableRedraw:!0}),a.a.createElement(l.e,{style:{fontSize:20,margin:8,color:"#FFFF00"}},"Waiting for other players"),a.a.createElement(l.a,{size:"large",color:"#FFFF00"}))):a.a.createElement(a.a.Fragment,null,a.a.createElement(l.e,{style:{fontSize:20,margin:8}},"Draw"),a.a.createElement(w.b,{prompt:null!==(n=c.prompt)&&void 0!==n?n:"",onDone:function(t){c.doodle=Object(j.d)(t),e.controller.sendAssignment(c)}}))},k=function(){var e=p();return a.a.createElement(a.a.Fragment,null,a.a.createElement(O,{controller:e}),a.a.createElement(C,{controller:e}))},C=function(e){var t=e.controller,n=Object(r.useState)("profile"),i=n[0],o=n[1];return t.loading?a.a.createElement(l.a,{size:"large",color:"#FFFF00"}):"debug"===t.gameState.client.role?a.a.createElement(R,{controller:t}):"viewer"===t.gameState.client.role?a.a.createElement(K,{controller:t}):"profile"===i?a.a.createElement(E,{controller:t,onDone:function(){o("play")}}):a.a.createElement(D,{controller:t})},R=function(e){var t=e.controller,n=t.gameState,r=t._messages,i=t._events;return a.a.createElement(a.a.Fragment,null,a.a.createElement(K,{controller:e.controller}),a.a.createElement(l.h,{style:{marginTop:64,background:"#555555"}},a.a.createElement(l.e,{style:{fontSize:20}},"Debug"),a.a.createElement(l.h,null,a.a.createElement(l.e,null,"Query: "+JSON.stringify(n.client._query)),a.a.createElement(l.e,null,"Room: "+n.client.room),a.a.createElement(l.e,null,"Role: "+n.client.role)),a.a.createElement(l.e,{style:{fontSize:20}},"Web Sockets"),a.a.createElement(l.h,null,a.a.createElement(l.h,{style:{padding:4}},a.a.createElement(l.e,{style:{whiteSpace:"pre-wrap",fontSize:18}},"Events"),i.map((function(e,t){return a.a.createElement(l.e,{key:t,style:{whiteSpace:"pre-wrap",fontSize:14}},JSON.stringify(e))}))),a.a.createElement(l.h,{style:{padding:4}},a.a.createElement(l.e,{style:{whiteSpace:"pre-wrap",fontSize:18}},"Messages"),r.map((function(e,t){return a.a.createElement(l.e,{key:t,style:{whiteSpace:"pre-wrap",fontSize:14}},e.timestamp+" "+(e.receivedAtTimestamp-e.timestamp)+": "+JSON.stringify(e))}))))))}}}]);
//# sourceMappingURL=20-2ebdd74137830c21455e.js.map