"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[412],{1412:function(e,t,n){n.r(t),n.d(t,{DoodleBrowseView:function(){return D},DoodleBrowser:function(){return F},DoodleDisplayView:function(){return x},DoodleDrawerView:function(){return k},DoodleGameView_ChooseBest:function(){return A},DoodleGameView_DrawWord:function(){return K},DoodleGameView_TypeExpected:function(){return j},DoodlePartyView:function(){return Q},DoodlePartyView_Inner:function(){return Z},DoodleTestView:function(){return S},createDoodleDrawingStorageService:function(){return w},decodeDoodleDrawing:function(){return i},defaultDoodleDrawing:function(){return r},doodleSegmentToSvgPath_line:function(){return c},doodleStoragePaths:function(){return m},doodleToSvg:function(){return d},encodeDoodleDrawing:function(){return s}});var l=n(1738);const r=()=>({width:104,height:104,segments:[]}),o=e=>{if(e.length<=0)return"";let t=e[0],n="";return e.slice(1).forEach((e=>{n+=`${e.x-t.x},${e.y-t.y};`,t=e})),n},a=(e,t,n)=>{if(!n)return[{x:e,y:t}];let l={x:e,y:t};return[...n.split(";").filter((e=>e)).map((e=>{const t=e.split(","),n={x:l.x+Number.parseInt(t[0],10),y:l.y+Number.parseInt(t[1],10)};return l=n,n}))]},s=e=>{const t={w:e.width,h:e.height,s:e.segments.map((e=>({x:e.points[0].x,y:e.points[0].y,p:o(e.points)})))};return{doodleText:JSON.stringify(t)}},i=e=>{const t=JSON.parse(e.doodleText);return{width:t.w,height:t.h,segments:t.s.map((e=>({points:[{x:e.x,y:e.y},...a(e.x,e.y,e.p)]})))}},c=e=>{if(e.points.length<=0)return"";if(1===e.points.length)return`M${e.points[0].x} ${e.points[0].y} L${e.points[0].x} ${e.points[0].y}`;let t=e.points[0];return`M${e.points[0].x} ${e.points[0].y} l${e.points.slice(1).map((e=>{const n=`${e.x-t.x} ${e.y-t.y}`;return t=e,n})).join(" ")}`},d=e=>`\n<svg viewBox='0 0 ${e.width} ${e.height}' stroke='#000000' fill='transparent'>\n    ${e.segments.map(((e,t)=>`<path d='${c(e)}' />`)).join("")}\n</svg>\n    `.trim(),m={doodleSummary:"doodle/summary",doodleDrawingsPrefix:"doodle/drawings",doodlePartyDrawingsPrefix:"doodle/party/drawings",doodleVotesPrefix:"doodle/votes"};var u=n(6135),y=n(6766),p=n(5950),g=n(3880),v=n(9232);const h=()=>{var e;try{return JSON.parse(null!==(e=localStorage.getItem("doodleStorage.v2"))&&void 0!==e?e:"NULL!{}")}catch(t){return null}},f=e=>{localStorage.setItem("doodleStorage.v2",JSON.stringify(e))},w=async e=>{var t,n,l,r;const o=(0,v.GF)({getUploadUrl:async()=>{var e,t;return null!==(t=null===(e=h())||void 0===e?void 0:e.doodleUploadUrl)&&void 0!==t?t:null},setUploadUrl:async e=>{var t;return f(Object.assign(Object.assign({},null!==(t=h())&&void 0!==t?t:{}),{doodleUploadUrl:e}))},uploadApiUrl:e.uploadApiUrl,uploadUrlPrefix:m.doodleDrawingsPrefix}),a=(0,v.GF)({getUploadUrl:async()=>{var e,t;return null!==(t=null===(e=h())||void 0===e?void 0:e.scoresUploadUrl)&&void 0!==t?t:null},setUploadUrl:async e=>{var t;return f(Object.assign(Object.assign({},null!==(t=h())&&void 0!==t?t:{}),{scoresUploadUrl:e}))},uploadApiUrl:e.uploadApiUrl,uploadUrlPrefix:m.doodleVotesPrefix}),c=await(async()=>{var t;try{let n=null===(t=h())||void 0===t?void 0:t.doodleUploadUrl;if(!n){const t=(0,v.tS)(e);n=(await t.createUploadUrl({})).uploadUrl}const l=null===n||void 0===n?void 0:n.getUrl.replace(n.relativePath,""),r=`${l}${m.doodleSummary}`;console.log("getSummaryData",{uploadUrl:n,serverUrl:l,summaryUrl:r});const o=await(0,v.O6)(r);return{doodles:o.doodles.map((e=>({key:e.k,prompt:e.p,timestamp:e.t,drawing:i(e.d),score:e.s})))}}catch(n){return{doodles:[]}}})(),d={doodles:[],doodleScores:[],doodleVotes:[]};d.doodles=null!==(n=null===(t=await o.load())||void 0===t?void 0:t.doodles.map((e=>({key:e.k,prompt:e.p,timestamp:e.t,drawing:e.d?i(e.d):e.drawing}))))&&void 0!==n?n:[],d.doodleVotes=null!==(r=null===(l=await a.load())||void 0===l?void 0:l.doodleVotes)&&void 0!==r?r:[];const u={};c.doodles.forEach((e=>{var t;u[e.key]=(null!==(t=u[e.key])&&void 0!==t?t:0)+e.score})),d.doodleScores=(0,p.dY)(u).map((e=>({doodleKey:e.key,score:e.value})));return{saveDrawing:async(e,t)=>{const n={key:`${e.substr(0,8)}:${Date.now()}:${Math.floor(999999*Math.random())}`,drawing:t,prompt:e,timestamp:Date.now()};d.doodles.push(n),setTimeout((async()=>{await o.save({doodles:d.doodles.map((e=>({k:e.key,p:e.prompt,t:e.timestamp,d:s(e.drawing)})))})}))},saveBestDrawingSelection:async e=>{var t;d.doodleVotes.push({k:e.key,t:Date.now()});let n=d.doodleScores.find((t=>t.doodleKey===e.key));n||(n={doodleKey:e.key,score:0},d.doodleScores.push(n)),n.score=(null!==(t=n.score)&&void 0!==t?t:0)+1,setTimeout((async()=>{await a.save({doodleVotes:d.doodleVotes})}))},getDrawings:async(e,t)=>{const{includeOtherPrompts:n=!1,maxCount:l=4}=null!==t&&void 0!==t?t:{},r=(0,p.Xq)([...c.doodles,...d.doodles.map((e=>{var t,n;return Object.assign(Object.assign({},e),{score:null!==(n=null===(t=d.doodleScores.find((t=>t.doodleKey===e.key)))||void 0===t?void 0:t.score)&&void 0!==n?n:0})}))],(e=>e.key)),o=r.filter((t=>t.prompt===e)).sort(((e,t)=>-(e.score-t.score)));console.log("getDrawings",{samePromptDrawings:o});const a=n?r.filter((t=>t.prompt!==e)):[],s=n?[(0,p.TF)(o),...(0,p.TV)(a).slice(0,l-1)]:o;return{doodles:(0,p.TV)(s).slice(0,l)}},getAllDrawings:async()=>({doodles:(0,p.Xq)([...c.doodles,...d.doodles.map((e=>{var t,n;return Object.assign(Object.assign({},e),{score:null!==(n=null===(t=d.doodleScores.find((t=>t.doodleKey===e.key)))||void 0===t?void 0:t.score)&&void 0!==n?n:0})}))],(e=>e.key))})}},E={drawing:{width:312,height:312,color:"#FFFFFF",backgroundColor:"#000000"}},S=e=>{const[t,n]=(0,l.useState)(r());return l.createElement(l.Fragment,null,l.createElement(k,{style:E.drawing,drawing:t,onChange:n}),l.createElement(x,{style:E.drawing,drawing:t}))},k=e=>{const{style:t,drawing:n,onChange:r}=e,o=t.width/n.width,[a,s]=(0,l.useState)(null),i=(0,l.useRef)(null),d=(0,l.useRef)(null),m=e=>(e.preventDefault(),e.stopPropagation(),e.nativeEvent.cancelBubble=!0,e.nativeEvent.returnValue=!1,!1),u=(e,t)=>{var n,l,r,a;const c=d.current;if(!c)return m(e);const u=c.getBoundingClientRect(),y={clientX:null!==(l=null!==(n=null===t||void 0===t?void 0:t.clientX)&&void 0!==n?n:e.clientX)&&void 0!==l?l:0,clientY:null!==(a=null!==(r=null===t||void 0===t?void 0:t.clientY)&&void 0!==r?r:e.clientY)&&void 0!==a?a:0};return i.current={clientX:y.clientX,clientY:y.clientY,x:Math.floor((y.clientX-u.x)/o),y:Math.floor((y.clientY-u.y)/o)},s({points:[{x:i.current.x,y:i.current.y}]}),m(e)},y=e=>{const t=a;return t?(r(Object.assign(Object.assign({},n),{segments:[...n.segments,t]})),s(null),i.current=null,m(e)):m(e)},p=(e,t)=>{var n,l,r,a;if(!i.current)return m(e);const c=null!==(l=null!==(n=null===t||void 0===t?void 0:t.clientX)&&void 0!==n?n:e.clientX)&&void 0!==l?l:0,d=null!==(a=null!==(r=null===t||void 0===t?void 0:t.clientY)&&void 0!==r?r:e.clientY)&&void 0!==a?a:0;return(e=>{s((t=>{if(!t)return null;const n=t.points[t.points.length-1];return Math.abs(n.x-e.x)+Math.abs(n.y-e.y)<=2?t:{points:[...t.points,e]}}))})({x:Math.floor((c-i.current.clientX)/o)+i.current.x,y:Math.floor((d-i.current.clientY)/o)+i.current.y}),m(e)};return(0,l.useEffect)((()=>{const e=e=>!i.current||(e.preventDefault(),e.stopPropagation(),e.cancelBubble=!0,e.returnValue=!1,!1);return document.addEventListener("touchmove",e,{passive:!1}),()=>{document.removeEventListener("touchmove",e)}}),[]),l.createElement(l.Fragment,null,l.createElement("div",{style:{position:"relative",width:t.width,height:t.height,backgroundColor:t.backgroundColor}},l.createElement("svg",{style:{width:t.width,height:t.height},viewBox:`0 0 ${n.width} ${n.height}`,preserveAspectRatio:"none",xmlns:"http://www.w3.org/2000/svg"},n.segments.map(((e,n)=>l.createElement("path",{key:n,d:c(e),stroke:t.color,fill:"transparent"}))),a&&l.createElement("path",{d:c(a),stroke:t.color,fill:"transparent"})),l.createElement("div",{ref:d,style:{position:"absolute",left:0,right:0,top:0,bottom:0,zIndex:10},onMouseDown:u,onMouseUp:y,onMouseMove:p,onMouseLeave:y,onTouchStart:e=>u(e,e.touches[0]),onTouchEnd:y,onTouchCancel:y,onTouchMove:e=>p(e,e.touches[0]),onTouchEndCapture:y})))},x=e=>{var t;const[n,r]=(0,l.useState)(0),o=()=>{e.enableRedraw&&r((e=>e+1))};return e.enableRedraw?l.createElement(u.Au,{onPress:o},l.createElement(b,Object.assign({key:n},e,{shouldAnimate:n>0||(null===(t=e.shouldAnimate)||void 0===t||t)}))):l.createElement(b,Object.assign({},e))},b=({style:e,drawing:t,shouldAnimate:n=!0,animatePointsPerSecond:r=20})=>{const[o,a]=(0,l.useState)(0),s=t.segments.flatMap((e=>e.points)).length;(0,l.useEffect)((()=>{if(!n)return()=>{};const e=setInterval((()=>{a((t=>(t>s&&clearInterval(e),t+Math.ceil(r/10))))}),10);return()=>{clearInterval(e)}}),[t]);let i=n?o:Number.MAX_SAFE_INTEGER;return l.createElement("div",{style:{width:e.width,height:e.height,backgroundColor:e.backgroundColor}},l.createElement("svg",{style:{width:e.width,height:e.height},viewBox:`0 0 ${t.width} ${t.height}`,preserveAspectRatio:"none",xmlns:"http://www.w3.org/2000/svg"},t.segments.map(((t,n)=>{const r=i;return i=Math.max(0,i-t.points.length),l.createElement("path",{key:n,d:c({points:[...t.points.slice(0,r)]}),stroke:e.color,fill:"transparent"})}))))},F=({config:e})=>{const{loading:t,error:n,doWork:r}=(0,g.VL)(),[o,a]=(0,l.useState)([]);return(0,l.useEffect)((()=>{r((async()=>{const t=await w(e),n=await t.getAllDrawings();a(n.doodles)}))}),[]),n?l.createElement(y.C.ErrorBox,{error:n}):t?l.createElement(u.P2,{size:"large",color:"#FFFF00"}):l.createElement(D,{doodles:o})},D=({doodles:e})=>{const t=(0,p.dY)((0,p.sD)(e,(e=>e.prompt)));return l.createElement(l.Fragment,null,t.map((e=>l.createElement(u.G7,{key:e.key,style:{padding:4}},l.createElement(u.xv,{style:{fontSize:12}},e.key),l.createElement(u.G7,{style:{padding:4,flexDirection:"row",flexWrap:"wrap"}},e.value.map((e=>l.createElement(u.G7,{key:e.key,style:{padding:4,alignItems:"center"}},l.createElement(x,{style:{width:104,height:104,color:"#FFFFFF",backgroundColor:"#000000"},drawing:e.drawing,shouldAnimate:!1,enableRedraw:!0}),l.createElement(u.xv,null,`${e.score}`)))))))))},M={rows:[{keys:"qwertyuiop".split("")},{keys:" asdfghjkl".split("")},{keys:"  zxcvbnm ".split("")}]},C={container:{},rowView:{flex:1,flexDirection:"row"},keyView:{margin:2,padding:2,flex:1,height:20,backgroundColor:"#111111",justifyContent:"center",alignItems:"center"},keyView_disabled:{opacity:.5},keyText:{fontSize:16},keyText_wrong:{fontSize:16,color:"#FF0000"}},T=({expectedCharacter:e,showHints:t,onExpectedKeyPress:n})=>{const r=M,[o,a]=(0,l.useState)(null),[s,i]=(0,l.useState)([]);(0,l.useEffect)((()=>{t||a(null);const n=[e,...(0,p.TV)(r.rows.flatMap((e=>e.keys)).map((e=>e.trim())).filter((e=>e))).slice(0,3)];a(n),i([])}),[e,t]);return l.createElement(l.Fragment,null,l.createElement(u.G7,{style:C.container},r.rows.map(((r,c)=>l.createElement(u.G7,{style:C.rowView,key:`${c}`},r.keys.map(((r,c)=>l.createElement(u.Au,{key:`${r}${c}`,style:{outline:"none"},onPress:()=>{var l;(l=r)!==e?t&&(a((e=>(null!==e&&void 0!==e?e:[]).filter((e=>e!==l)))),i((e=>[...e,l]))):n()}},l.createElement(u.G7,{style:!o||o.includes(r)?{}:C.keyView_disabled},l.createElement(u.G7,{style:C.keyView},l.createElement(u.xv,{style:s.includes(r)?C.keyText_wrong:C.keyText},r)))))))))))},P={container:{alignItems:"center"},drawing:{width:312,height:312,color:"#FFFFFF",backgroundColor:"#000000"},drawingChoicesView:{maxWidth:332,flexDirection:"row",flexWrap:"wrap"},drawingChoiceWrapper:{padding:4},drawingChoice:{width:78,height:78,color:"#FFFFFF",backgroundColor:"#000000"},titleView:{justifyContent:"center",alignItems:"center"},titleText:{fontSize:20,color:"#FFFFFF"},promptView:{justifyContent:"center",alignItems:"center"},promptText:{fontSize:20,color:"#FFFF00"},hintText:{fontSize:14,color:"#FFFF00"},buttonRowView:{flexDirection:"row"},buttonView:{margin:4,padding:8,backgroundColor:"#111111"},buttonText:{fontSize:20,color:"#FFFF00"}},K=e=>{const[t,n]=(0,l.useState)(r());return(0,l.useEffect)((()=>{n(r())}),[e.prompt]),l.createElement(u.G7,{style:P.container},l.createElement(u.G7,{style:P.titleView},l.createElement(u.xv,{style:P.titleText},"Draw")),l.createElement(k,{style:P.drawing,drawing:t,onChange:e=>{n(e)}}),l.createElement(u.G7,{style:P.promptView},l.createElement(u.xv,{style:P.promptText},e.prompt),!!e.hint&&l.createElement(u.xv,{style:P.hintText},e.hint)),l.createElement(u.G7,{style:P.buttonRowView},!!e.onSkip&&l.createElement(u.Au,{onPress:()=>{var t;null===(t=e.onSkip)||void 0===t||t.call(e)}},l.createElement(u.G7,{style:P.buttonView},l.createElement(u.xv,{style:P.buttonText},"Skip"))),l.createElement(u.Au,{onPress:()=>{e.onDone(t)}},l.createElement(u.G7,{style:P.buttonView},l.createElement(u.xv,{style:P.buttonText},"Done")))))},A=e=>l.createElement(u.G7,{style:P.container},l.createElement(u.G7,{style:P.titleView},l.createElement(u.xv,{style:P.titleText},"Choose Best")),l.createElement(u.G7,{style:P.promptView},l.createElement(u.xv,{style:P.promptText},e.prompt)),l.createElement(u.G7,{style:P.drawingChoicesView},e.drawings.map((t=>l.createElement(u.Au,{key:t.key,onPress:()=>e.onChooseBest(t)},l.createElement(u.G7,{style:P.drawingChoiceWrapper},l.createElement(x,{style:P.drawingChoice,drawing:t.drawing}))))))),G={completedText:{fontSize:16,color:"#FFFF00"}},j=e=>{var t;const[n,r]=(0,l.useState)({completed:"",remaining:e.prompt});(0,l.useEffect)((()=>{r({completed:"",remaining:e.prompt})}),[e.prompt,e.drawings]);return l.createElement(u.G7,{style:P.container},l.createElement(u.G7,{style:P.titleView},l.createElement(u.xv,{style:P.titleText},"Type Word")),l.createElement(u.G7,{style:P.drawingChoicesView},e.drawings.map((e=>l.createElement(u.G7,{key:e.key,style:P.drawingChoiceWrapper},l.createElement(x,{style:P.drawingChoice,drawing:e.drawing}))))),l.createElement(u.Au,{onPress:e.sayAgain},l.createElement(u.G7,{style:P.buttonView},l.createElement(u.xv,{style:P.buttonText},"Say Again"))),l.createElement(u.G7,null,l.createElement(u.xv,{style:G.completedText},`${n.completed}${n.remaining.length>0?"_":""}`)),l.createElement(T,{expectedCharacter:null!==(t=n.remaining[0])&&void 0!==t?t:" ",showHints:!0,onExpectedKeyPress:()=>{r((t=>{t.remaining.length<=1&&e.onDone();const n=t.remaining[0];return{completed:t.completed+n,remaining:t.remaining.substr(1)}}))}}))},O=e=>{var t,n;const{clientPlayer:r}=e.controller.clientState.client,[o,a]=(0,l.useState)(Object.assign({},r)),[s,i]=(0,l.useState)(null!==(n=null===(t=e.controller.meshState)||void 0===t?void 0:t.players.filter((e=>e.clientKey!==r.clientKey)).map((e=>e.emoji)))&&void 0!==n?n:[]);return(0,l.useEffect)((()=>{var t,n;i(null!==(n=null===(t=e.controller.meshState)||void 0===t?void 0:t.players.filter((e=>e.clientKey!==r.clientKey)).map((e=>e.emoji)))&&void 0!==n?n:[])}),[e.controller.renderId]),l.createElement(l.Fragment,null,l.createElement(y.C.View_Panel,null,l.createElement(y.C.Text_FormTitle,null,"User"),l.createElement(U,{userProfile:o,onUserProfileChange:t=>{a(t),e.controller.setClientPlayer(Object.assign(Object.assign({},t),{isReady:!1}))},usedEmojis:s}),l.createElement(y.C.View_FormActionRow,null,l.createElement(y.C.Button_FormAction,{onPress:()=>{e.controller.setClientPlayer(Object.assign(Object.assign({},r),{isReady:!0})),e.onDone()}},"Ready"))),l.createElement(V,Object.assign({},e)))},V=e=>{var t;return l.createElement(l.Fragment,null,l.createElement(u.G7,null,null===(t=e.controller.meshState)||void 0===t?void 0:t.players.filter((t=>!e.hideInactive||t.isActive)).map((e=>{return l.createElement(u.G7,{key:e.clientKey,style:{flexDirection:"row",alignItems:"center"}},l.createElement(u.G7,null,l.createElement(u.xv,{style:{fontSize:24}},(t=e).isActive?t.isReady?t.assignment&&t.assignment&&!t.assignment.doodle&&"doodle"===t.assignment.kind?"\ud83c\udfa8":t.assignment&&t.assignment&&!t.assignment.prompt&&"describe"===t.assignment.kind?"\u270f":"\u2714":"\u25fb":"\u274c")),l.createElement(u.G7,{style:{width:48}},l.createElement(u.xv,{style:{fontSize:32}},e.emoji)),l.createElement(u.G7,null,l.createElement(u.xv,{style:{fontSize:16}},e.name)));var t}))))},$="\n\ud83d\udc35 \ud83d\udc36 \ud83d\udc3a \ud83d\udc31 \ud83e\udd81 \ud83d\udc2f \ud83e\udd92 \ud83e\udd8a \ud83e\udd9d \ud83d\udc2e \ud83d\udc37 \ud83d\udc17 \ud83d\udc2d \ud83d\udc39 \ud83d\udc30 \ud83d\udc3b \ud83d\udc28 \ud83d\udc3c \ud83d\udc38 \ud83e\udd93 \ud83d\udc34 \ud83e\udd84 \ud83d\udc14 \ud83d\udc32 \n\ud83e\udd16 \ud83d\udc7d \ud83d\udc7b \ud83c\udf55 \ud83c\udf54 \ud83c\udf2d \ud83e\udd53 \ud83c\udf2e \ud83c\udf56 \ud83e\udd69 \ud83c\udf66 \ud83c\udf69 \ud83c\udf70 \ud83e\uddc1 \ud83e\udd5d \ud83e\udd65 \ud83c\udf52 \ud83c\udf53 \ud83c\udf44 \ud83e\udd66 \ud83e\udd51 \ud83e\udd55 \n\ud83d\ude97 \ud83d\ude91 \ud83d\ude92 \ud83d\ude9c \ud83e\uddbc \ud83d\udeb2 \ud83d\ude82 \ud83d\udee9 \ud83d\ude80 \ud83d\udef8 \ud83d\udef0 \ud83e\ude90 \ud83e\uddef \ud83e\uddf7  \ud83e\ude91 \ud83d\udece \u2602 \u26c4\n".replace(/\n/g,"").split(" ").map((e=>e.trim())).filter((e=>e)),U=({userProfile:e,onUserProfileChange:t,usedEmojis:n})=>{const[r,o]=(0,l.useState)($),[a,s]=(0,l.useState)(!1);return(0,l.useEffect)((()=>{o($.filter((e=>!n.includes(e))))}),[n]),a?l.createElement(l.Fragment,null,l.createElement(y.C.View_Form,null,l.createElement(u.G7,{style:{flexDirection:"row",flexWrap:"wrap"}},r.map((n=>l.createElement(u.Au,{key:n,onPress:()=>{return l=n,s(!1),void t(Object.assign(Object.assign({},e),{emoji:l}));var l}},l.createElement(u.G7,null,l.createElement(u.xv,{style:{fontSize:32}},n)))))))):l.createElement(l.Fragment,null,l.createElement(y.C.View_Form,null,l.createElement(y.C.View_FieldRow,null,l.createElement(u.Au,{onPress:()=>s(!0)},l.createElement(u.G7,null,l.createElement(u.xv,{style:{fontSize:32}},e.emoji))),l.createElement(I,{userProfile:e,onNameChange:n=>t(Object.assign(Object.assign({},e),{name:n}))}))))},I=({userProfile:e,onNameChange:t})=>{const[n,r]=(0,l.useState)(e.name||"Player"),[o,a]=(0,l.useState)(!1),s=()=>{t(n),a(!1)};return l.createElement(l.Fragment,null,l.createElement(y.C.Input_Text,{value:n,onChange:r,onSubmit:s,onFocus:()=>{r(""),a(!0)}}),o&&l.createElement(y.C.Button_FieldInline,{onPress:s},"Set Name"))},R=e=>{const{clientState:t,meshState:n}=e.controller,{clientPlayer:r,role:o}=t.client;return l.createElement(l.Fragment,null,l.createElement(u.G7,{key:r.clientKey,style:{padding:4,flexDirection:"row",alignItems:"center"}},"player"===o&&r?l.createElement(l.Fragment,null,l.createElement(u.G7,{style:{width:36}},l.createElement(u.xv,{style:{fontSize:24}},r.emoji)),l.createElement(u.G7,null,l.createElement(u.xv,{style:{fontSize:16}},r.name))):l.createElement(l.Fragment,null,l.createElement(u.G7,null,l.createElement(u.xv,{style:{fontSize:16}},o))),l.createElement(u.G7,{style:{flex:1}}),l.createElement(u.G7,null,l.createElement(u.xv,{style:{fontSize:16}},(null===n||void 0===n?void 0:n.hostClientKey)===t.client.clientPlayer.clientKey?"\ud83d\udfe2":""))))},z=e=>{var t,n,r,o;const a=null!==(n=null===(t=e.controller.meshState)||void 0===t?void 0:t.history.rounds.flatMap(((e,t)=>e.completed.map((e=>{var n;return{iRound:t,item:e,chainKey:null===(n=e.assignment)||void 0===n?void 0:n.chainKey}})))))&&void 0!==n?n:[],s=(0,p.dY)((0,p.sD)(a,(e=>{var t;return null!==(t=e.chainKey)&&void 0!==t?t:""}))).map((e=>({chain:e.key,items:e.value.sort(((e,t)=>e.iRound-t.iRound))})));return l.createElement(u.G7,null,l.createElement(u.xv,null,"Players"),l.createElement(V,{controller:e.controller}),l.createElement(u.xv,null,"Rounds"),l.createElement(u.xv,null,`${null!==(o=null===(r=e.controller.meshState)||void 0===r?void 0:r.history.rounds.length)&&void 0!==o?o:0}`),l.createElement(u.xv,null,"Chains"),l.createElement(u.G7,null,s.map(((e,t)=>l.createElement(u.G7,{key:`${t}`,style:{margin:4,padding:4,background:"#444444"}},l.createElement(u.G7,{style:{flexDirection:"row",alignItems:"center",flexWrap:"wrap"}},e.items.map((e=>l.createElement(u.G7,{key:e.item.clientKey,style:{padding:4}},l.createElement(_,{player:e.item}))))))))))},_=e=>{var t,n;const r=e.player,{assignment:o}=e.player;return l.createElement(u.G7,{style:{flexDirection:"column",alignItems:"center",width:104}},l.createElement(u.xv,null,r.name),l.createElement(u.xv,null,r.emoji),l.createElement(u.xv,{style:{color:"#FFFF00",whiteSpace:"pre-wrap"}},"doodle"===(null===o||void 0===o?void 0:o.kind)&&null!==(t=null===o||void 0===o?void 0:o.prompt)&&void 0!==t?t:""),!!(null===o||void 0===o?void 0:o.doodle)&&l.createElement(x,{style:{width:104,height:104,color:"#FFFFFF",backgroundColor:"#000000"},drawing:i(o.doodle),shouldAnimate:!0,enableRedraw:!0}),l.createElement(u.xv,{style:{color:"#FFFF00",whiteSpace:"pre-wrap"}},"describe"===(null===o||void 0===o?void 0:o.kind)&&null!==(n=null===o||void 0===o?void 0:o.prompt)&&void 0!==n?n:""))},N=e=>{var t,n;const{clientState:r,meshState:o}=e.controller,{clientKey:a}=r.client.clientPlayer,c=null===(t=null===o||void 0===o?void 0:o.players.find((e=>e.clientKey===a)))||void 0===t?void 0:t.assignment,[d,m]=(0,l.useState)("");if((0,l.useEffect)((()=>{m("")}),[c]),!c)return l.createElement(l.Fragment,null,l.createElement(u.G7,{style:{padding:8}},l.createElement(u.xv,null,"Please Wait Until Next Round")),l.createElement(z,{controller:e.controller}));if("describe"===c.kind&&c.doodle){const t=()=>{c.prompt=d,e.controller.sendAssignment(c)};return l.createElement(l.Fragment,null,l.createElement(u.G7,{style:{flexDirection:"column",alignItems:"center"}},l.createElement(u.xv,{style:{fontSize:20,margin:8}},"Describe"),l.createElement(x,{style:{width:312,height:312,color:"#FFFFFF",backgroundColor:"#000000"},drawing:i(c.doodle),shouldAnimate:!0,enableRedraw:!0}),!c.prompt&&l.createElement(l.Fragment,null,l.createElement(u.xv,{style:{fontSize:20,margin:8,color:"#FFFF00"}},"What is this?"),l.createElement(y.C.Input_Text,{value:d,onChange:m,onSubmit:t}),l.createElement(y.C.Button_FieldInline,{onPress:t},"Done")),c.prompt&&l.createElement(l.Fragment,null,l.createElement(u.xv,{style:{fontSize:20,margin:8,color:"#FFFF00"}},c.prompt),l.createElement(u.xv,{style:{fontSize:20,margin:8,color:"#FFFF00"}},"Waiting for other players"),l.createElement(V,{controller:e.controller,hideInactive:!0}),l.createElement(u.G7,{style:{padding:8}},l.createElement(u.P2,{size:"large",color:"#FFFF00"})))))}return c.doodle?l.createElement(l.Fragment,null,l.createElement(u.G7,{style:{flexDirection:"column",alignItems:"center"}},l.createElement(u.xv,{style:{fontSize:20,margin:8}},"Draw"),l.createElement(x,{style:{width:312,height:312,color:"#FFFFFF",backgroundColor:"#000000"},drawing:i(c.doodle),shouldAnimate:!0,enableRedraw:!0}),l.createElement(u.xv,{style:{fontSize:20,margin:8,color:"#FFFF00"}},"Waiting for other players"),l.createElement(V,{controller:e.controller,hideInactive:!0}),l.createElement(u.G7,{style:{padding:8}},l.createElement(u.P2,{size:"large",color:"#FFFF00"})))):l.createElement(l.Fragment,null,l.createElement(u.xv,{style:{fontSize:20,margin:8}},"Draw"),l.createElement(K,{prompt:null!==(n=c.prompt)&&void 0!==n?n:"",onDone:t=>{c.doodle=s(t),e.controller.sendAssignment(c)}}))};var W=n(5772);const B=(e,t)=>{const n=[],l=[],r={send:null},o=[],a=(e=>({connect:({channelKey:t})=>{const n=(0,p.Li)(),l=(0,p.Li)(),r=()=>{const r=new WebSocket(`${e.websocketsApiUrl}`);return r.addEventListener("open",(e=>{if(r!==a)return void r.close();l.onStateChange({connectionStatus:"opened"});const n={message:null,key:t};r.send(JSON.stringify(n))})),r.addEventListener("close",(e=>{r===a?(l.onStateChange({connectionStatus:"closed"}),s()):r.close()})),r.addEventListener("error",(e=>{r===a?(l.onStateChange({connectionStatus:"error",error:{message:"Websocket Error",error:e}}),s()):r.close()})),r.addEventListener("message",(e=>{if(r!==a)return void r.close();const l=JSON.parse(e.data);l.key===t&&l.message&&n.onStateChange(l.message)})),r};let o=!1,a=r();const s=()=>{o||setTimeout((()=>{a=r()}),50)};return{send:e=>{if(!a||a.readyState!==WebSocket.OPEN)throw new p.gz("Websocket is not open");const n={message:e,key:t};a.send(JSON.stringify(n))},isConnected:()=>(null===a||void 0===a?void 0:a.readyState)===WebSocket.OPEN,subscribeMessages:n.subscribe,subscribeConnectionEvents:l.subscribe,close:()=>{o=!0,null===a||void 0===a||a.close(),a=null}}}}))({websocketsApiUrl:e.websocketsApiUrl}).connect({channelKey:e.channelKey}),s=a.subscribeMessages((e=>{t(e),n.push(Object.assign(Object.assign({},e),{_r:Date.now()}))})),i=a.subscribeConnectionEvents((e=>{r.send=a.isConnected()?a.send:null,l.push(e)})),c=setInterval((()=>d()),250),d=()=>{if(!r.send)return;const e=o.splice(0,o.length);for(const t of e)r.send(t)};return{send:e=>{r.send?(d(),r.send(e)):o.push(e)},unsubscribe:()=>{clearInterval(c),r.send=null,s.unsubscribe(),i.unsubscribe(),a.close()},history:{messages:n,events:l}}},L=({channelKey:e,initialState:t,reduceState:n,reduceClientsState:l,websocketsApiConfig:r})=>{var o;const a="_webMeshClientKey",s=null!==(o=localStorage.getItem(a))&&void 0!==o?o:`${Date.now()}-${Math.floor(999999*Math.random())}`;localStorage.setItem(a,s);const i=(0,p.Li)(),c={meshState:t,meshMetaData:{clients:[],firstMessageTimestamp:0,lastMessageTimestamp:0}},d=[];let m=setTimeout((()=>{}),0);const u=B({websocketsApiUrl:r.websocketsApiUrl,channelKey:`wm_${e}`},(e=>{if("close"===e.kind)return clearTimeout(m),c.meshMetaData.clients=c.meshMetaData.clients.filter((t=>t.key!==e.c)),c.meshState=l(c.meshState,c.meshMetaData.clients),void i.onStateChange(c.meshState);if((e=>{const t=[...c.meshMetaData.clients];c.meshMetaData.clients=c.meshMetaData.clients.filter((t=>t.key!==e.c)),c.meshMetaData.clients.push({key:e.c,lastActivityTimestamp:e.t}),c.meshMetaData.clients.sort(((e,t)=>-(e.lastActivityTimestamp-t.lastActivityTimestamp))),t.map((e=>e.key)).join(";")!==c.meshMetaData.clients.map((e=>e.key)).join(";")&&(c.meshState=l(c.meshState,c.meshMetaData.clients),i.onStateChange(c.meshState))})(e),"pong"===e.kind)return clearTimeout(null!==h&&void 0!==h?h:0),void(h=null);if("ping"===e.kind)return clearTimeout(null!==h&&void 0!==h?h:0),h=null,void(e.clientKeys.includes(s)&&setTimeout(v));if("drop"===e.kind)return clearTimeout(null!==h&&void 0!==h?h:0),h=null,c.meshMetaData.clients=c.meshMetaData.clients.filter((t=>!e.clientKeys.some((e=>e===t.key)))),c.meshState=l(c.meshState,c.meshMetaData.clients),void i.onStateChange(c.meshState);if("join"!==e.kind){if("sync"===e.kind){if(e.c===s)return;if(c.meshMetaData.firstMessageTimestamp&&c.meshMetaData.firstMessageTimestamp<e.state.meshMetaData.firstMessageTimestamp)return void(m=setTimeout(g,1e4));clearTimeout(m),c.meshMetaData.firstMessageTimestamp=e.state.meshMetaData.firstMessageTimestamp,c.meshMetaData.lastMessageTimestamp=e.state.meshMetaData.lastMessageTimestamp,c.meshMetaData.clients=(0,p.Xq)([...c.meshMetaData.clients,...e.state.meshMetaData.clients],(e=>e.key)),c.meshState=e.state.meshState;const t=d.filter((e=>e.t>c.meshMetaData.lastMessageTimestamp));for(const e of t){if("message"!==e.kind)return;c.meshState=n(c.meshState,e.message),c.meshMetaData.lastMessageTimestamp=e.t}return c.meshState=l(c.meshState,c.meshMetaData.clients),void i.onStateChange(c.meshState)}"message"===e.kind&&(d.push(e),c.meshMetaData.firstMessageTimestamp||(c.meshMetaData.firstMessageTimestamp=e.t),c.meshMetaData.lastMessageTimestamp=e.t,c.meshState=n(c.meshState,e.message),i.onStateChange(c.meshState))}else{if(clearTimeout(m),e.c===s)return;const t=c.meshMetaData.clients.findIndex((e=>e.key===s))-1;m=setTimeout(g,t>=0?2e3*t:1e4)}})),y=e=>{u.send(Object.assign(Object.assign({},e),{c:s,t:Date.now()}))},g=()=>{c.meshMetaData.clients=c.meshMetaData.clients.filter((e=>e.key!==s)),c.meshMetaData.clients.unshift({key:s,lastActivityTimestamp:Date.now()}),y({kind:"sync",state:c})},v=()=>{y({kind:"pong"})};let h=null;const f=setInterval((()=>{if(h)return;if(c.meshMetaData.clients.filter((e=>Date.now()>45e3+e.lastActivityTimestamp)).length>0){const e=c.meshMetaData.clients.findIndex((e=>e.key===s));return void(h=setTimeout((()=>{h=null;const e=c.meshMetaData.clients.filter((e=>Date.now()>45e3+e.lastActivityTimestamp));e.length<=0||y({kind:"drop",clientKeys:e.map((e=>e.key))})}),5e3*e))}if(c.meshMetaData.clients.filter((e=>Date.now()>3e4+e.lastActivityTimestamp)).length<=0)return;const e=c.meshMetaData.clients.findIndex((e=>e.key===s));h=setTimeout((()=>{h=null;const e=c.meshMetaData.clients.filter((e=>Date.now()>3e4+e.lastActivityTimestamp));e.length<=0||y({kind:"ping",clientKeys:e.map((e=>e.key))})}),5e3*e)}),5e3);let w=!1;return y({kind:"join"}),{_webSocket:{history:u.history},clientKey:s,sendMessage:e=>{if(w)throw new p.gz("The connection is closed");y({kind:"message",message:e})},subscribe:i.subscribe,close:()=>{w||(w=!0,y({kind:"close"}),u.unsubscribe(),clearInterval(f))}}},Y=()=>{const e="_DoodleGameClient";return{clientStorage:{load:()=>{var t;try{return JSON.parse(null!==(t=localStorage.getItem(e))&&void 0!==t?t:"NULL!{}")}catch(n){return null}},save:t=>{localStorage.setItem(e,JSON.stringify(t))}}}},J=(e,t,n)=>{var l,r,o;const a="Choose Your Own Word",s=()=>({kind:"doodle",prompt:a,chainKey:`${Date.now()}-${Math.floor(999999*Math.random())}`}),i=e.players.find((e=>e.clientKey===t));if(!i)return s();const c=e.history.rounds.flatMap((e=>e.completed)).filter((e=>e.clientKey===i.clientKey)),d=null!==(l=c[c.length-1])&&void 0!==l?l:void 0,m=null!==(o=null===(r=null===d||void 0===d?void 0:d.assignment)||void 0===r?void 0:r.kind)&&void 0!==o?o:"doodle",u=new Set(e.history.rounds.flatMap((e=>e.completed)).filter((e=>e.clientKey===i.clientKey)).filter((e=>{var t;return(null===(t=e.assignment)||void 0===t?void 0:t.prompt)!==a})).map((e=>{var t,n,l;return null!==(l=null===(n=null===(t=e.assignment)||void 0===t?void 0:t.prompt)||void 0===n?void 0:n.toLowerCase().trim())&&void 0!==l?l:""}))),y=n.findIndex((e=>{var t,n;return!u.has(null!==(n=null===(t=e.prompt)||void 0===t?void 0:t.toLowerCase().trim())&&void 0!==n?n:"")&&e.kind===m}));if(y<0)return s();const p=n.splice(y,1)[0],g=Object.assign({},p);return"doodle"===g.kind?(g.kind="describe",g.prompt=void 0):(g.kind="doodle",g.doodle=void 0),g},X=(e,t)=>{var n;if(console.log("reduceState",{message:t}),"setHost"===t.kind)return e.hostClientKey=t.hostClientKey,e;if("setPlayer"===t.kind){let n=e.players.find((e=>e.clientKey===t.clientPlayer.clientKey));return n||(n=Object.assign(Object.assign({},t.clientPlayer),{isActive:!0}),e.players.push(n)),n.name=t.clientPlayer.name,n.emoji=t.clientPlayer.emoji,n.isReady=t.clientPlayer.isReady,e}if("assign"===t.kind)return e.players=t.players,t.lastRound&&t.lastRound.completed.length>0&&(e.history.rounds.find((e=>{var n;return e.roundKey===(null===(n=t.lastRound)||void 0===n?void 0:n.roundKey)}))||e.history.rounds.push(t.lastRound)),e;if("completeAssignment"===t.kind){const l=null===(n=e.players.find((e=>e.clientKey===t.playerAssignment.clientKey)))||void 0===n?void 0:n.assignment;return l?(l.prompt=t.playerAssignment.prompt,l.doodle=t.playerAssignment.doodle,e):e}return e},q=(e,t)=>(console.log("reduceClientsState",{clients:t}),e.players.forEach((e=>{e.isActive=!!t.find((t=>t.key===e.clientKey))})),e.clients=(0,p.EB)([...e.clients,...t].map((e=>e.key))).map((e=>({key:e,isActive:!!t.find((t=>t.key===e))}))),e),H=e=>{var t,n,r,o;const a=(0,l.useRef)((()=>{const e=(0,W.mB)(window.location.search);var t;return{client:{_query:e,room:(t=e.room,null!==t&&void 0!==t?t:"UnknownRoom"),role:(e=>{switch(e){case"debug":return"debug";case"viewer":return"viewer";default:return"player"}})(e.role),clientPlayer:{isActive:!0,clientKey:"",name:"",emoji:"\ud83d\udc64",isReady:!1}}}})()).current,[s,c]=(0,l.useState)(!0),[d,u]=(0,l.useState)(0),y=()=>{u((e=>e+1))},g=(0,l.useRef)(null),h=(0,l.useRef)(null),f=(0,l.useRef)(null);(0,l.useEffect)((()=>{const t=L({channelKey:`doodle_${a.client.room}`,initialState:{hostClientKey:"",clients:[],players:[],history:{rounds:[]}},reduceState:X,reduceClientsState:q,websocketsApiConfig:e}),n=t.subscribe((e=>{g.current=e,y()}));f.current={history:t._webSocket.history},h.current=t.sendMessage,(()=>{const{clientStorage:e}=Y(),t=e.load();t&&(a.client.clientPlayer={clientKey:"",name:t.clientPlayer.name,emoji:t.clientPlayer.emoji,isReady:!1,isActive:!0}),y()})(),a.client.clientPlayer.clientKey=t.clientKey;const l=setInterval((()=>{var n;const l=g.current;if(!l)return;(null===(n=l.clients.find((e=>e.key===l.hostClientKey)))||void 0===n?void 0:n.isActive)?l.hostClientKey===t.clientKey&&((e,t,n)=>{if(t.players.filter((e=>e.isActive&&e.isReady)).length<=0)return;const l=(0,p.dY)((0,p.sD)(t.history.rounds.flatMap((e=>e.completed)).map((e=>e.assignment)).filter((e=>e)).map((e=>e)),(e=>{var t;return null!==(t=null===e||void 0===e?void 0:e.chainKey)&&void 0!==t?t:""}))).map((e=>e.value[e.value.length-1]));if(t.players.some((e=>e.isActive&&e.isReady&&e.assignment&&(!e.assignment.doodle||!e.assignment.prompt)))){const e=t.players.filter((e=>!e.assignment));return e.length>0?(e.forEach((e=>{e.assignment=J(t,e.clientKey,l)})),void n({kind:"assign",players:t.players,lastRound:void 0})):void 0}const r=[...t.players.filter((e=>e.assignment&&e.assignment.doodle&&e.assignment.prompt&&i(e.assignment.doodle).segments.length>0)).map((e=>Object.assign(Object.assign({},e),{assignment:e.assignment?Object.assign({},e.assignment):void 0})))],o={roundKey:`${Date.now()}`,completed:r};t.history.rounds.push(o);for(let a=0;a<t.players.length;a++)t.players[a].assignment=J(t,t.players[a].clientKey,l);n({kind:"assign",players:t.players,lastRound:o}),setTimeout((async()=>{const n=(0,v.tS)(e),l=(await n.createUploadUrl({prefix:`${m.doodlePartyDrawingsPrefix}/${Date.now()}`})).uploadUrl,r=(0,v._s)(l);await r.uploadData({history:t.history})}))})(e,l,t.sendMessage):t.sendMessage({kind:"setHost",hostClientKey:t.clientKey})}),3e3+Math.floor(3e3*Math.random()));return c(!1),()=>{n.unsubscribe(),t.close(),clearInterval(l)}}),[]);return{loading:s,renderId:d,clientState:a,meshState:g.current,setClientPlayer:e=>{const{clientStorage:t}=Y();a.client.clientPlayer=Object.assign(Object.assign({},a.client.clientPlayer),e),t.save({clientPlayer:a.client.clientPlayer}),(()=>{var e;"player"===a.client.role&&(null===(e=h.current)||void 0===e||e.call(h,{kind:"setPlayer",clientPlayer:a.client.clientPlayer}))})(),y()},sendAssignment:e=>{var t;"player"===a.client.role&&(null===(t=h.current)||void 0===t||t.call(h,{kind:"completeAssignment",playerAssignment:Object.assign(Object.assign({},e),{clientKey:a.client.clientPlayer.clientKey})}))},_messages:null!==(n=null===(t=f.current)||void 0===t?void 0:t.history.messages)&&void 0!==n?n:[],_events:null!==(o=null===(r=f.current)||void 0===r?void 0:r.history.events)&&void 0!==o?o:[]}},Q=({config:e})=>{const t=H(e);return l.createElement(l.Fragment,null,l.createElement(R,{controller:t}),l.createElement(Z,{controller:t}))},Z=({controller:e})=>{const[t,n]=(0,l.useState)("profile"),r=()=>{n("play")};return e.loading?l.createElement(u.P2,{size:"large",color:"#FFFF00"}):"debug"===e.clientState.client.role?l.createElement(ee,{controller:e}):"viewer"===e.clientState.client.role?l.createElement(z,{controller:e}):"profile"===t?l.createElement(O,{controller:e,onDone:r}):l.createElement(N,{controller:e})},ee=e=>{var t;const{clientState:n,meshState:r,_events:o,_messages:a}=e.controller,[s,i]=(0,l.useState)(0);return(0,l.useEffect)((()=>{const e=setInterval((()=>{i((e=>e+1))}),1e3);return()=>{clearInterval(e)}}),[]),l.createElement(l.Fragment,null,l.createElement(z,{controller:e.controller}),l.createElement(u.G7,{style:{marginTop:64,background:"#555555"}},l.createElement(u.xv,{style:{fontSize:20}},"Debug"),l.createElement(u.G7,null,l.createElement(u.xv,null,`Query: ${JSON.stringify(n.client._query)}`),l.createElement(u.xv,null,`Room: ${n.client.room}`),l.createElement(u.xv,null,`Role: ${n.client.role}`)),l.createElement(u.G7,{style:{padding:4}},l.createElement(u.xv,{style:{whiteSpace:"pre-wrap",fontSize:18}},"Host"),l.createElement(u.xv,{style:{whiteSpace:"pre-wrap",fontSize:14}},`'${null!==(t=null===r||void 0===r?void 0:r.hostClientKey)&&void 0!==t?t:""}'`),l.createElement(u.xv,{style:{whiteSpace:"pre-wrap",fontSize:18}},"Players"),null===r||void 0===r?void 0:r.players.map(((e,t)=>l.createElement(u.xv,{key:t,style:{whiteSpace:"pre-wrap",fontSize:14}},JSON.stringify(e))))),l.createElement(u.xv,{style:{fontSize:20}},"Web Sockets"),l.createElement(u.G7,null,l.createElement(u.G7,{style:{padding:4}},l.createElement(u.xv,{style:{whiteSpace:"pre-wrap",fontSize:18}},"Events"),o.map(((e,t)=>l.createElement(u.xv,{key:t,style:{whiteSpace:"pre-wrap",fontSize:14}},JSON.stringify(e))))),l.createElement(u.G7,{style:{padding:4}},l.createElement(u.xv,{style:{whiteSpace:"pre-wrap",fontSize:18}},"Messages"),a.map(((e,t)=>l.createElement(u.xv,{key:t,style:{whiteSpace:"pre-wrap",fontSize:14}},`${e.t} ${e._r-e.t}: ${JSON.stringify(e)}`)))))))}}}]);