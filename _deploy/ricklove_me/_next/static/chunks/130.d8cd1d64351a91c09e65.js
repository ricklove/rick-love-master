"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[130],{3130:function(e,t,n){n.r(t),n.d(t,{DoodleBrowseView:function(){return se},DoodleBrowser:function(){return ie},DoodleDisplayView:function(){return le},DoodleDrawerView:function(){return oe},DoodlePartyView:function(){return Me},DoodlePartyView_Inner:function(){return je},DoodleTestView:function(){return re},styles:function(){return ne}});var r=n(1738);const o=e=>{if(e.length<=0)return"";let t=e[0],n="";return e.slice(1).forEach((e=>{n+=`${e.x-t.x},${e.y-t.y};`,t=e})),n},l=(e,t,n)=>{if(!n)return[{x:e,y:t}];let r={x:e,y:t};return[...n.split(";").filter((e=>e)).map((e=>{const t=e.split(","),n={x:r.x+Number.parseInt(t[0],10),y:r.y+Number.parseInt(t[1],10)};return r=n,n}))]},a=e=>{const t={w:e.width,h:e.height,s:e.segments.map((e=>({x:e.points[0].x,y:e.points[0].y,p:o(e.points)})))};return{doodleText:JSON.stringify(t)}},i=e=>{const t=JSON.parse(e.doodleText);return{width:t.w,height:t.h,segments:t.s.map((e=>({points:[{x:e.x,y:e.y},...l(e.x,e.y,e.p)]})))}},s=e=>{if(e.points.length<=0)return"";if(1===e.points.length)return`M${e.points[0].x} ${e.points[0].y} L${e.points[0].x} ${e.points[0].y}`;let t=e.points[0];return`M${e.points[0].x} ${e.points[0].y} l${e.points.slice(1).map((e=>{const n=`${e.x-t.x} ${e.y-t.y}`;return t=e,n})).join(" ")}`},c={doodleSummary:"doodle/summary",doodleDrawingsPrefix:"doodle/drawings",doodlePartyDrawingsPrefix:"doodle/party/drawings",doodleVotesPrefix:"doodle/votes"};var d=n(6637);function u(e){var t;if(Array.isArray(e)){if(1===e.length)return null!==(t=u(e[0]))&&void 0!==t?t:{};let n=Object.assign({},u(e[0]));return e.forEach((e=>{n=Object.assign(Object.assign({},n),u(null!==e&&void 0!==e?e:{}))})),null!==n&&void 0!==n?n:{}}return e}const m={display:"flex",flexDirection:"column"},g={whiteSpace:"pre"},p=e=>{const t=e;return"none"===t.userSelect&&(t.MozUserSelect="none",t.WebkitUserSelect="none"),e},y=e=>r.createElement("div",{style:u([m,e.style])},e.children),h=e=>{if(1===e.numberOfLines){const t={overflow:"hidden",whiteSpace:"nowrap",wordWrap:"break-word",textOverflow:"ellipsis"},n=u([g,e.style,t]);return r.createElement("span",{style:p(n)},e.children)}const t=u([g,e.style]);return r.createElement("span",{style:p(t)},e.children)},f=e=>{var t,n;const o="numeric"===e.keyboardType?"number":e.secureTextEntry?"password":"text",l="username"===e.autoCompleteType?"username":"password"===e.autoCompleteType?"password":void 0,a=e.onSubmitEditing&&(t=>{var n;"Enter"!==t.key||t.shiftKey||(t.preventDefault(),null===(n=e.onSubmitEditing)||void 0===n||n.call(e))})||void 0;return e.multiline?r.createElement("textarea",{name:l,id:l,style:u([g,e.style]),placeholder:e.placeholder,disabled:!(null===(t=e.editable)||void 0===t||t),value:e.value,onFocus:e.onFocus,onChange:t=>e.onChange(t.target.value),onKeyPress:a,onBlur:e.onBlur,rows:e.numberOfLines,onSelect:t=>{var n,r,o;const l=t.target,a={start:null!==(n=l.selectionStart)&&void 0!==n?n:0,end:null!==(r=l.selectionEnd)&&void 0!==r?r:0};(l.selectionStart||l.selectionEnd)&&(null===(o=e.onSelectionChange)||void 0===o||o.call(e,a))}}):r.createElement("input",{type:o,name:l,id:l,style:u([g,e.style]),placeholder:e.placeholder,disabled:!(null===(n=e.editable)||void 0===n||n),value:e.value,onFocus:e.onFocus,onChange:t=>e.onChange(t.target.value),onKeyPress:a,onBlur:e.onBlur})},v=e=>{const t=(0,r.useRef)(Date.now()),n=()=>{Date.now()<t.current+250||(t.current=Date.now(),e.onPress())},o=(0,r.useRef)(!0);return r.createElement("div",{style:u([m,e.style]),onClick:n,onKeyPress:n,onTouchStart:()=>{o.current=!0},onTouchMove:()=>{o.current=!1},onTouchEnd:()=>{o.current&&n()},role:"button",tabIndex:0},e.children)},b=({size:e,color:t})=>{const n="small"===e?16:32;return r.createElement(E,{size:n,thickness:n/8,color:t})},w=d.iv`
  .activity-spinner {
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }
    50% {
      transform: rotate(180deg);
    }
    100% {
      transform: rotate(360deg);
    }
  }

  .activity-spinner-2 {
    animation: spin-2 0.7s linear infinite;
  }

  @keyframes spin-2 {
    0% {
      transform: rotate(360deg);
    }
    50% {
      transform: rotate(180deg);
    }
    100% {
      transform: rotate(0deg);
    }
  }
`,E=({size:e,thickness:t,color:n})=>{const o=.6*(2*Math.PI*(e-t)*.5);return r.createElement(r.Fragment,null,r.createElement(d.xB,{styles:w}),r.createElement("svg",{style:{maxWidth:e},viewBox:`0 0 ${e} ${e}`,xmlns:"http://www.w3.org/2000/svg"},r.createElement("circle",{style:{fill:"transparent",stroke:n,strokeWidth:t,opacity:.5},cx:.5*e,cy:.5*e,r:.5*e-t}),r.createElement("circle",{className:"activity-spinner",style:{strokeDasharray:o,fill:"transparent",stroke:n,strokeWidth:t,transformOrigin:`${.5*e}px ${.5*e}px`},cx:.5*e,cy:.5*e,r:.5*e-t})))},S=async e=>{await navigator.clipboard.writeText(e)},k=e=>{var t,n,r,o,l,a,i,s;return{display:e.display,flexDirection:e.flexDirection,flex:e.flex,justifyContent:e.justifyContent,alignItems:e.alignItems,overflow:e.overflow,background:e.background,margin:e.margin,marginLeft:null!==(t=e.margin)&&void 0!==t?t:e.marginLeft,marginRight:null!==(n=e.margin)&&void 0!==n?n:e.marginRight,marginTop:null!==(r=e.margin)&&void 0!==r?r:e.marginTop,marginBottom:null!==(o=e.margin)&&void 0!==o?o:e.marginBottom,padding:e.padding,paddingRight:null!==(l=e.padding)&&void 0!==l?l:e.paddingRight,paddingLeft:null!==(a=e.padding)&&void 0!==a?a:e.paddingLeft,paddingTop:null!==(i=e.padding)&&void 0!==i?i:e.paddingTop,paddingBottom:null!==(s=e.padding)&&void 0!==s?s:e.paddingBottom,width:e.width,minWidth:e.minWidth,maxWidth:e.maxWidth,height:e.height,borderWidth:e.borderWidth,borderRadius:e.borderRadius,borderColor:e.borderColor,borderStyle:e.borderStyle,outlineColor:e.outlineColor}},x={text:"#333333",text_header:"#333333",text_button:"#333333",text_error:"#333333",text_errorMessage:"#ff3333",border:"#cccccc",border_minor:"#cccccc",border_input:"#cccccc",outline:"#888888",background:"#ffffff",background_field:"#dddddd",background_button:"#eeeeee",background_error:"#ffcccc",loader:"#3333ff",icon:"#3333ff"},F=e=>{var t,n,r,o;return{borderWidth:e.all,borderLeftWidth:null!==(t=e.left)&&void 0!==t?t:e.all,borderRightWidth:null!==(n=e.right)&&void 0!==n?n:e.all,borderTopWidth:null!==(r=e.top)&&void 0!==r?r:e.all,borderBottomWidth:null!==(o=e.bottom)&&void 0!==o?o:e.all}},D={textPadding:4,borderWidth:{all:1},borderWidth_minor:{all:1},borderWidth_input:{all:1},borderRadius:4,sectionGap:16,elementGap:8,rowGap:4,rowPadding:4,fontSize:14,fontSize_input:16,fontSize_button:14,fontSize_header:16,lineHeight:"18px",minWidth_label:120,minWidth_input:120,minWidth_button:120,icon:14},_={fontFamily:'"Trebuchet MS", Helvetica, Roboto, sans-serif',fontWeight_normal:"normal",fontWeight_button:"bold",fontWeight_header:"bold"},M=(e,t,n)=>{const r=Object.assign(Object.assign({},F(t.borderWidth)),{borderRadius:t.borderRadius,borderColor:e.border,borderStyle:"solid",outlineColor:e.outline}),o=Object.assign(Object.assign({},F(t.borderWidth_minor)),{borderRadius:t.borderRadius,borderColor:e.border_minor,borderStyle:"solid",outlineColor:e.outline}),l=Object.assign(Object.assign({},F(t.borderWidth_input)),{borderRadius:t.borderRadius,borderColor:e.border_input,borderStyle:"solid",outlineColor:e.outline});let a={},i={},s={},c={};return{colors:e,sizes:t,font:n,view_panel:a={background:e.background,padding:t.elementGap},view_form:a=Object.assign(Object.assign({},r),{marginBottom:t.sectionGap,padding:t.elementGap}),text_formTitle:i={padding:t.textPadding,color:e.text_header,fontSize:t.fontSize_header,fontFamily:n.fontFamily,fontWeight:n.fontWeight_header},view_formFields:a=Object.assign(Object.assign({},o),{marginBottom:t.rowGap,background:e.background_field}),view_fieldRow:a={marginLeft:t.rowPadding,display:"flex",flexDirection:"row",alignItems:"center",flexWrap:"wrap"},text_fieldLabel:i={padding:t.textPadding,color:e.text,fontSize:t.fontSize,fontWeight:n.fontWeight_normal,minWidth:t.minWidth_label},input_fieldEntry:i=Object.assign(Object.assign({},l),{marginBottom:t.rowGap,marginRight:t.rowGap,padding:t.textPadding,color:e.text,fontSize:t.fontSize_input,fontWeight:n.fontWeight_normal,lineHeight:t.lineHeight,minWidth:t.minWidth_input}),button_fieldInline:c=Object.assign(Object.assign({},r),{marginBottom:t.rowGap,marginRight:t.rowGap,padding:t.textPadding,background:e.background_button,color:e.text_button,fontSize:t.fontSize_button,fontWeight:n.fontWeight_button,lineHeight:t.lineHeight,display:"flex",minWidth:t.minWidth_button}),button_fieldInline_alt:c=Object.assign(Object.assign({},c),{background:e.text_button,color:e.background_button,borderColor:e.background_button}),view_formActionRow:a={display:"flex",flexDirection:"row",justifyContent:"flex-end",marginBottom:t.elementGap},button_formAction:c=Object.assign(Object.assign({},r),{marginLeft:t.elementGap,padding:t.textPadding,background:e.background_button,color:e.text_button,fontSize:t.fontSize_button,fontWeight:n.fontWeight_button,lineHeight:t.lineHeight,minWidth:t.minWidth_button}),button_formAction_alt:c=Object.assign(Object.assign({},c),{background:e.text_button,color:e.background_button,borderColor:e.background_button}),view_error:a=Object.assign(Object.assign({},r),{marginBottom:t.sectionGap,padding:t.rowPadding,background:e.background_error}),text_error:i={padding:t.textPadding,color:e.text_error,fontSize:t.fontSize,fontFamily:n.fontFamily,fontWeight:n.fontWeight_button},text_errorMessage:i={padding:t.textPadding,color:e.text_errorMessage,fontSize:t.fontSize,fontFamily:n.fontFamily,fontWeight:n.fontWeight_button},icon:s={size:t.icon,color:e.icon,outlineColor:e.outline},icon_errorMessage:s={size:t.icon,color:e.text_errorMessage,outlineColor:e.outline}}};Object.assign(Object.assign({},x),{text:"#2b2b2b",text_header:"#863d8f",text_button:"#ffffff",border:"#863d8f",border_minor:"#863d8f",border_input:"#aaaaaa",background:"#ffffff",background_field:"#dddddd",background_button:"#863d8f",loader:"#863d8f",icon:"#863d8f"}),Object.assign(Object.assign({},D),{borderWidth:{all:1,bottom:4},borderWidth_minor:{all:0,bottom:1}});let j=M(x,D,_);const C=e=>{var t;const n=null!==(t=e.style)&&void 0!==t?t:e.styleAlt?j.button_formAction_alt:j.button_formAction;return r.createElement(v,{style:k(n),onPress:e.onPress},r.createElement(h,{style:(o=n,{color:o.color,fontFamily:o.fontFamily,fontSize:o.fontSize,fontWeight:o.fontWeight,lineHeight:o.lineHeight,outlineColor:o.outlineColor})},e.children));var o};var O,P=n(9504),T=n(3737),U=n(3941),W=n(7050);!function(e){e[e.menu=0]="menu",e[e.back=1]="back",e[e.error=2]="error",e[e.expanded=3]="expanded",e[e.collapsed=4]="collapsed",e[e.copy=5]="copy",e[e.retry=6]="retry",e[e.dashboard=7]="dashboard",e[e.add=8]="add",e[e.remove=9]="remove",e[e.eye=10]="eye",e[e.eyeSlash=11]="eyeSlash",e[e.checkChecked=12]="checkChecked",e[e.checkUnchecked=13]="checkUnchecked",e[e.account=14]="account",e[e.message=15]="message",e[e.subscription=16]="subscription",e[e.calendar=17]="calendar",e[e.contacts=18]="contacts",e[e.keys=19]="keys",e[e.resources=20]="resources",e[e.admin=21]="admin"}(O||(O={}));const z=e=>{var t,n,o,l,a;const i=function(e){switch(e){case O.menu:return{name:"menu",component:W.xXU};case O.back:return{name:"arrow-back",component:W.KYK};case O.error:return{name:"error-outline",component:W.wr$};case O.expanded:return{name:"chevron-down",component:U.bTu};case O.collapsed:return{name:"chevron-right",component:U.Tfp};case O.copy:return{name:"content-copy",component:W.Fqs};case O.retry:return{name:"reload",component:T.WLu};case O.dashboard:return{name:"dashboard",component:W.bUq};case O.add:return{name:"plus",component:T.wEH};case O.remove:return{name:"minus",component:T.iFH};case O.eye:return{name:"eye",component:T.dSq};case O.eyeSlash:return{name:"eye-slash",component:T.tgn};case O.checkChecked:return{name:"checked",component:T.xik};case O.checkUnchecked:return{name:"unchecked",component:T.u9M};default:return{name:"unknown",component:W.hrt}}}(e.kind),s=i.component,c=null!==(o=null!==(n=null===(t=e.style)||void 0===t?void 0:t.size)&&void 0!==n?n:j.icon.size)&&void 0!==o?o:j.sizes.fontSize;return r.createElement(y,{style:{width:c,height:c}},r.createElement(s,{name:i.name,size:c,color:null!==(a=null===(l=e.style)||void 0===l?void 0:l.color)&&void 0!==a?a:j.icon.color}))},R={view:j.view_error,text:j.text_error,text_errorMessage:j.text_errorMessage,icon:j.icon,icon_errorMessage:j.icon_errorMessage,button:{outlineColor:j.colors.outline}},A=e=>{var t,n;const[o,l]=(0,r.useState)(!1),a="string"===typeof e.error?`${e.error}`:null,i=null!==(n=null!==(t=e.error.message)&&void 0!==t?t:a)&&void 0!==n?n:"Unknown Error",s=e.error.data?(0,P.PO)(e.error.data,!0):void 0,c=e.error&&(0,P.PO)(e.error,!0)||void 0,d=!!s||!!c;return r.createElement(y,{style:R.view},r.createElement(y,{style:{flexDirection:"row"}},r.createElement(v,{style:Object.assign({flex:1,flexDirection:"row",alignItems:"center"},R.button),onPress:()=>l(!o)},d&&(o?r.createElement(z,{style:R.icon,kind:O.expanded}):r.createElement(z,{style:R.icon,kind:O.collapsed})),r.createElement(y,{style:{paddingRight:8}},r.createElement(z,{style:R.icon,kind:O.error})),r.createElement(y,{style:{flex:1,overflow:"hidden"}},r.createElement(h,{style:R.text,numberOfLines:o?void 0:1},i))),r.createElement(v,{style:Object.assign({flexDirection:"row",alignItems:"center",paddingLeft:8},R.button),onPress:()=>S((0,P.PO)({errorMessage:i,errorDetails:s,errorObjText:c},!0))},r.createElement(z,{style:R.icon,kind:O.copy})),e.error.retryCallback&&r.createElement(v,{style:Object.assign({flexDirection:"row",alignItems:"center",paddingLeft:8},R.button),onPress:e.error.retryCallback},r.createElement(z,{style:R.icon,kind:O.retry}))),d&&o&&!!s&&r.createElement(h,{style:Object.assign({},R.text)},s),d&&o&&!!c&&r.createElement(h,{style:Object.assign({},R.text)},c))},K=({error:e})=>e?r.createElement(A,{error:e}):r.createElement(r.Fragment,null),I=e=>r.createElement(y,Object.assign({style:j.view_panel},e)),$=e=>r.createElement(y,Object.assign({style:j.view_form},e)),L=e=>r.createElement(y,Object.assign({style:j.view_fieldRow},e)),N=e=>r.createElement(y,Object.assign({style:j.view_formActionRow},e)),V=e=>r.createElement(h,Object.assign({style:j.text_formTitle},e)),B=e=>r.createElement(C,Object.assign({style:e.styleAlt?j.button_fieldInline_alt:j.button_fieldInline},e)),G=e=>r.createElement(C,Object.assign({style:e.styleAlt?j.button_formAction_alt:j.button_formAction},e)),H=e=>{var t;return r.createElement(f,{style:null!==(t=e.style)&&void 0!==t?t:j.input_fieldEntry,keyboardType:"default",autoCompleteType:"off",placeholder:e.placeholder,editable:e.editable,value:`${e.value}`,onChange:t=>e.onChange(t),onSubmitEditing:e.onSubmit,onFocus:e.onFocus,onBlur:e.onBlur})};var J=n(3880);function Y(e,t,n=1e4){return Promise.race([fetch(e,t),new Promise(((e,t)=>setTimeout((()=>t(new P.MS("Fetch Timeout"))),n)))])}const X=e=>{async function t(t,n){const r=`${e.uploadApiUrl}/${t}`,o={endpoint:t,data:n};return(await async function(e,t,n){var r,o;const l=JSON.stringify(t),a={method:null!==(r=null===n||void 0===n?void 0:n.method)&&void 0!==r?r:"POST",headers:{Accept:"application/json","Content-Type":"application/json","Content-Length":`${l.length}`},body:l},i=await Y(e,a,null===n||void 0===n?void 0:n.timeoutMs).catch((n=>{throw new P.MS("Request Failure",{url:e,data:t,error:n})}));if(!i.ok)throw new P.MS("Api Error",{data:null!==(o=await i.json().catch((e=>{})))&&void 0!==o?o:{},responseStatus:i.status,request:{url:e,data:t}});return await i.json().catch((n=>{throw new P.MS("Request Parse Failure",{url:e,data:t,error:n})}))}(r,o)).data}return{createUploadUrl:e=>t("createUploadUrl",e),renewUploadUrl:e=>t("renewUploadUrl",e)}},q=async e=>{const t=await Y(e,{method:"GET",headers:{Accept:"application/json"}});return(await t.json()).data},Q=e=>({uploadData:async t=>{const n=JSON.stringify({data:t});if(!(await Y(e.putUrl,{method:"PUT",headers:{Accept:"application/json","Content-Type":"application/json","Content-Length":`${n.length}`},body:n})).ok)throw new P.gz("Upload Failed")},downloadData:async()=>await q(e.getUrl)}),Z=e=>{const t=X(e);let n=null;const r=async()=>n||(n=await e.getUploadUrl(),n||(n=(await t.createUploadUrl({prefix:e.uploadUrlPrefix})).uploadUrl,await e.setUploadUrl(n),n));return{load:async()=>{const e=await r();try{return await q(e.getUrl)}catch(t){return null}},save:async o=>{let l=await r();try{const e=Q(l);await e.uploadData(o)}catch(s){l=(await t.renewUploadUrl({uploadUrl:l})).uploadUrl,await e.setUploadUrl(l),n=l;const r=Q(l);await r.uploadData(o)}const a=(await t.createUploadUrl({prefix:`backup/${l.relativePath}`})).uploadUrl,i=Q(a);await i.uploadData(o)}}},ee=()=>{var e;try{return JSON.parse(null!==(e=localStorage.getItem("doodleStorage.v2"))&&void 0!==e?e:"NULL!{}")}catch(t){return null}},te=e=>{localStorage.setItem("doodleStorage.v2",JSON.stringify(e))},ne={drawing:{width:312,height:312,color:"#FFFFFF",backgroundColor:"#000000"}},re=e=>{const[t,n]=(0,r.useState)({width:104,height:104,segments:[]});return r.createElement(r.Fragment,null,r.createElement(oe,{style:ne.drawing,drawing:t,onChange:n}),r.createElement(le,{style:ne.drawing,drawing:t}))},oe=e=>{const{style:t,drawing:n,onChange:o}=e,l=t.width/n.width,[a,i]=(0,r.useState)(null),c=(0,r.useRef)(null),d=(0,r.useRef)(null),u=e=>(e.preventDefault(),e.stopPropagation(),e.nativeEvent.cancelBubble=!0,e.nativeEvent.returnValue=!1,!1),m=(e,t)=>{var n,r,o,a;const s=d.current;if(!s)return u(e);const m=s.getBoundingClientRect(),g={clientX:null!==(r=null!==(n=null===t||void 0===t?void 0:t.clientX)&&void 0!==n?n:e.clientX)&&void 0!==r?r:0,clientY:null!==(a=null!==(o=null===t||void 0===t?void 0:t.clientY)&&void 0!==o?o:e.clientY)&&void 0!==a?a:0};return c.current={clientX:g.clientX,clientY:g.clientY,x:Math.floor((g.clientX-m.x)/l),y:Math.floor((g.clientY-m.y)/l)},i({points:[{x:c.current.x,y:c.current.y}]}),u(e)},g=e=>{const t=a;return t?(o(Object.assign(Object.assign({},n),{segments:[...n.segments,t]})),i(null),c.current=null,u(e)):u(e)},p=(e,t)=>{var n,r,o,a;if(!c.current)return u(e);const s=null!==(r=null!==(n=null===t||void 0===t?void 0:t.clientX)&&void 0!==n?n:e.clientX)&&void 0!==r?r:0,d=null!==(a=null!==(o=null===t||void 0===t?void 0:t.clientY)&&void 0!==o?o:e.clientY)&&void 0!==a?a:0;return(e=>{i((t=>{if(!t)return null;const n=t.points[t.points.length-1];return Math.abs(n.x-e.x)+Math.abs(n.y-e.y)<=2?t:{points:[...t.points,e]}}))})({x:Math.floor((s-c.current.clientX)/l)+c.current.x,y:Math.floor((d-c.current.clientY)/l)+c.current.y}),u(e)};return(0,r.useEffect)((()=>{const e=e=>!c.current||(e.preventDefault(),e.stopPropagation(),e.cancelBubble=!0,e.returnValue=!1,!1);return document.addEventListener("touchmove",e,{passive:!1}),()=>{document.removeEventListener("touchmove",e)}}),[]),r.createElement(r.Fragment,null,r.createElement("div",{style:{position:"relative",width:t.width,height:t.height,backgroundColor:t.backgroundColor}},r.createElement("svg",{style:{width:t.width,height:t.height},viewBox:`0 0 ${n.width} ${n.height}`,preserveAspectRatio:"none",xmlns:"http://www.w3.org/2000/svg"},n.segments.map(((e,n)=>r.createElement("path",{key:n,d:s(e),stroke:t.color,fill:"transparent"}))),a&&r.createElement("path",{d:s(a),stroke:t.color,fill:"transparent"})),r.createElement("div",{ref:d,style:{position:"absolute",left:0,right:0,top:0,bottom:0,zIndex:10},onMouseDown:m,onMouseUp:g,onMouseMove:p,onMouseLeave:g,onTouchStart:e=>m(e,e.touches[0]),onTouchEnd:g,onTouchCancel:g,onTouchMove:e=>p(e,e.touches[0]),onTouchEndCapture:g})))},le=e=>{var t;const[n,o]=(0,r.useState)(0),l=()=>{e.enableRedraw&&o((e=>e+1))};return e.enableRedraw?r.createElement(v,{onPress:l},r.createElement(ae,Object.assign({key:n},e,{shouldAnimate:n>0||(null===(t=e.shouldAnimate)||void 0===t||t)}))):r.createElement(ae,Object.assign({},e))},ae=({style:e,drawing:t,shouldAnimate:n=!0,animatePointsPerSecond:o=20})=>{const[l,a]=(0,r.useState)(0),i=t.segments.flatMap((e=>e.points)).length;(0,r.useEffect)((()=>{if(!n)return()=>{};const e=setInterval((()=>{a((t=>(t>i&&clearInterval(e),t+Math.ceil(o/10))))}),10);return()=>{clearInterval(e)}}),[t]);let c=n?l:Number.MAX_SAFE_INTEGER;return r.createElement("div",{style:{width:e.width,height:e.height,backgroundColor:e.backgroundColor}},r.createElement("svg",{style:{width:e.width,height:e.height},viewBox:`0 0 ${t.width} ${t.height}`,preserveAspectRatio:"none",xmlns:"http://www.w3.org/2000/svg"},t.segments.map(((t,n)=>{const o=c;return c=Math.max(0,c-t.points.length),r.createElement("path",{key:n,d:s({points:[...t.points.slice(0,o)]}),stroke:e.color,fill:"transparent"})}))))},ie=({config:e})=>{const{loading:t,error:n,doWork:o}=(0,J.VL)(),[l,s]=(0,r.useState)([]);return(0,r.useEffect)((()=>{o((async()=>{const t=await(async e=>{var t,n,r,o;const l=Z({getUploadUrl:async()=>{var e,t;return null!==(t=null===(e=ee())||void 0===e?void 0:e.doodleUploadUrl)&&void 0!==t?t:null},setUploadUrl:async e=>{var t;return te(Object.assign(Object.assign({},null!==(t=ee())&&void 0!==t?t:{}),{doodleUploadUrl:e}))},uploadApiUrl:e.uploadApiUrl,uploadUrlPrefix:c.doodleDrawingsPrefix}),s=Z({getUploadUrl:async()=>{var e,t;return null!==(t=null===(e=ee())||void 0===e?void 0:e.scoresUploadUrl)&&void 0!==t?t:null},setUploadUrl:async e=>{var t;return te(Object.assign(Object.assign({},null!==(t=ee())&&void 0!==t?t:{}),{scoresUploadUrl:e}))},uploadApiUrl:e.uploadApiUrl,uploadUrlPrefix:c.doodleVotesPrefix}),d=await(async()=>{var t;try{let n=null===(t=ee())||void 0===t?void 0:t.doodleUploadUrl;if(!n){const t=X(e);n=(await t.createUploadUrl({})).uploadUrl}const r=null===n||void 0===n?void 0:n.getUrl.replace(n.relativePath,""),o=`${r}${c.doodleSummary}`;console.log("getSummaryData",{uploadUrl:n,serverUrl:r,summaryUrl:o});return{doodles:(await q(o)).doodles.map((e=>({key:e.k,prompt:e.p,timestamp:e.t,drawing:i(e.d),score:e.s})))}}catch(n){return{doodles:[]}}})(),u={doodles:[],doodleScores:[],doodleVotes:[]};u.doodles=null!==(n=null===(t=await l.load())||void 0===t?void 0:t.doodles.map((e=>({key:e.k,prompt:e.p,timestamp:e.t,drawing:e.d?i(e.d):e.drawing}))))&&void 0!==n?n:[],u.doodleVotes=null!==(o=null===(r=await s.load())||void 0===r?void 0:r.doodleVotes)&&void 0!==o?o:[];const m={};return d.doodles.forEach((e=>{var t;m[e.key]=(null!==(t=m[e.key])&&void 0!==t?t:0)+e.score})),u.doodleScores=(0,P.dY)(m).map((e=>({doodleKey:e.key,score:e.value}))),{saveDrawing:async(e,t)=>{const n={key:`${e.substr(0,8)}:${Date.now()}:${Math.floor(999999*Math.random())}`,drawing:t,prompt:e,timestamp:Date.now()};u.doodles.push(n),setTimeout((async()=>{await l.save({doodles:u.doodles.map((e=>({k:e.key,p:e.prompt,t:e.timestamp,d:a(e.drawing)})))})}))},saveBestDrawingSelection:async e=>{var t;u.doodleVotes.push({k:e.key,t:Date.now()});let n=u.doodleScores.find((t=>t.doodleKey===e.key));n||(n={doodleKey:e.key,score:0},u.doodleScores.push(n)),n.score=(null!==(t=n.score)&&void 0!==t?t:0)+1,setTimeout((async()=>{await s.save({doodleVotes:u.doodleVotes})}))},getDrawings:async(e,t)=>{const{includeOtherPrompts:n=!1,maxCount:r=4}=null!==t&&void 0!==t?t:{},o=(0,P.Xq)([...d.doodles,...u.doodles.map((e=>{var t,n;return Object.assign(Object.assign({},e),{score:null!==(n=null===(t=u.doodleScores.find((t=>t.doodleKey===e.key)))||void 0===t?void 0:t.score)&&void 0!==n?n:0})}))],(e=>e.key)),l=o.filter((t=>t.prompt===e)).sort(((e,t)=>-(e.score-t.score)));console.log("getDrawings",{samePromptDrawings:l});const a=n?o.filter((t=>t.prompt!==e)):[],i=n?[(0,P.TF)(l),...(0,P.TV)(a).slice(0,r-1)]:l;return{doodles:(0,P.TV)(i).slice(0,r)}},getAllDrawings:async()=>({doodles:(0,P.Xq)([...d.doodles,...u.doodles.map((e=>{var t,n;return Object.assign(Object.assign({},e),{score:null!==(n=null===(t=u.doodleScores.find((t=>t.doodleKey===e.key)))||void 0===t?void 0:t.score)&&void 0!==n?n:0})}))],(e=>e.key))})}})(e),n=await t.getAllDrawings();s(n.doodles)}))}),[]),n?r.createElement(K,{error:n}):t?r.createElement(b,{size:"large",color:"#FFFF00"}):r.createElement(se,{doodles:l})},se=({doodles:e})=>{const t=(0,P.dY)((0,P.sD)(e,(e=>e.prompt)));return r.createElement(r.Fragment,null,t.map((e=>r.createElement(y,{key:e.key,style:{padding:4}},r.createElement(h,{style:{fontSize:12}},e.key),r.createElement(y,{style:{padding:4,flexDirection:"row",flexWrap:"wrap"}},e.value.map((e=>r.createElement(y,{key:e.key,style:{padding:4,alignItems:"center"}},r.createElement(le,{style:{width:104,height:104,color:"#FFFFFF",backgroundColor:"#000000"},drawing:e.drawing,shouldAnimate:!1,enableRedraw:!0}),r.createElement(h,null,`${e.score}`)))))))))},ce=("qwertyuiop".split("")," asdfghjkl".split(""),"  zxcvbnm ".split(""),{container:{alignItems:"center"},drawing:{width:312,height:312,color:"#FFFFFF",backgroundColor:"#000000"},drawingChoicesView:{maxWidth:332,flexDirection:"row",flexWrap:"wrap"},drawingChoiceWrapper:{padding:4},drawingChoice:{width:78,height:78,color:"#FFFFFF",backgroundColor:"#000000"},titleView:{justifyContent:"center",alignItems:"center"},titleText:{fontSize:20,color:"#FFFFFF"},promptView:{justifyContent:"center",alignItems:"center"},promptText:{fontSize:20,color:"#FFFF00"},hintText:{fontSize:14,color:"#FFFF00"},buttonRowView:{flexDirection:"row"},buttonView:{margin:4,padding:8,backgroundColor:"#111111"},buttonText:{fontSize:20,color:"#FFFF00"}}),de=e=>{const[t,n]=(0,r.useState)({width:104,height:104,segments:[]});return(0,r.useEffect)((()=>{n({width:104,height:104,segments:[]})}),[e.prompt]),r.createElement(y,{style:ce.container},r.createElement(y,{style:ce.titleView},r.createElement(h,{style:ce.titleText},"Draw")),r.createElement(oe,{style:ce.drawing,drawing:t,onChange:e=>{n(e)}}),r.createElement(y,{style:ce.promptView},r.createElement(h,{style:ce.promptText},e.prompt),!!e.hint&&r.createElement(h,{style:ce.hintText},e.hint)),r.createElement(y,{style:ce.buttonRowView},!!e.onSkip&&r.createElement(v,{onPress:()=>{var t;null===(t=e.onSkip)||void 0===t||t.call(e)}},r.createElement(y,{style:ce.buttonView},r.createElement(h,{style:ce.buttonText},"Skip"))),r.createElement(v,{onPress:()=>{e.onDone(t)}},r.createElement(y,{style:ce.buttonView},r.createElement(h,{style:ce.buttonText},"Done")))))},ue=e=>{var t,n;const{clientPlayer:o}=e.controller.clientState.client,[l,a]=(0,r.useState)(Object.assign({},o)),[i,s]=(0,r.useState)(null!==(n=null===(t=e.controller.meshState)||void 0===t?void 0:t.players.filter((e=>e.clientKey!==o.clientKey)).map((e=>e.emoji)))&&void 0!==n?n:[]);return(0,r.useEffect)((()=>{var t,n;s(null!==(n=null===(t=e.controller.meshState)||void 0===t?void 0:t.players.filter((e=>e.clientKey!==o.clientKey)).map((e=>e.emoji)))&&void 0!==n?n:[])}),[e.controller.renderId]),r.createElement(r.Fragment,null,r.createElement(I,null,r.createElement(V,null,"User"),r.createElement(pe,{userProfile:l,onUserProfileChange:t=>{a(t),e.controller.setClientPlayer(Object.assign(Object.assign({},t),{isReady:!1}))},usedEmojis:i}),r.createElement(N,null,r.createElement(G,{onPress:()=>{e.controller.setClientPlayer(Object.assign(Object.assign({},o),{isReady:!0})),e.onDone()}},"Ready"))),r.createElement(me,Object.assign({},e)))},me=e=>{var t;return r.createElement(r.Fragment,null,r.createElement(y,null,null===(t=e.controller.meshState)||void 0===t?void 0:t.players.filter((t=>!e.hideInactive||t.isActive)).map((e=>{return r.createElement(y,{key:e.clientKey,style:{flexDirection:"row",alignItems:"center"}},r.createElement(y,null,r.createElement(h,{style:{fontSize:24}},(t=e).isActive?t.isReady?t.assignment&&t.assignment&&!t.assignment.doodle&&"doodle"===t.assignment.kind?"\ud83c\udfa8":t.assignment&&t.assignment&&!t.assignment.prompt&&"describe"===t.assignment.kind?"\u270f":"\u2714":"\u25fb":"\u274c")),r.createElement(y,{style:{width:48}},r.createElement(h,{style:{fontSize:32}},e.emoji)),r.createElement(y,null,r.createElement(h,{style:{fontSize:16}},e.name)));var t}))))},ge="\n\ud83d\udc35 \ud83d\udc36 \ud83d\udc3a \ud83d\udc31 \ud83e\udd81 \ud83d\udc2f \ud83e\udd92 \ud83e\udd8a \ud83e\udd9d \ud83d\udc2e \ud83d\udc37 \ud83d\udc17 \ud83d\udc2d \ud83d\udc39 \ud83d\udc30 \ud83d\udc3b \ud83d\udc28 \ud83d\udc3c \ud83d\udc38 \ud83e\udd93 \ud83d\udc34 \ud83e\udd84 \ud83d\udc14 \ud83d\udc32 \n\ud83e\udd16 \ud83d\udc7d \ud83d\udc7b \ud83c\udf55 \ud83c\udf54 \ud83c\udf2d \ud83e\udd53 \ud83c\udf2e \ud83c\udf56 \ud83e\udd69 \ud83c\udf66 \ud83c\udf69 \ud83c\udf70 \ud83e\uddc1 \ud83e\udd5d \ud83e\udd65 \ud83c\udf52 \ud83c\udf53 \ud83c\udf44 \ud83e\udd66 \ud83e\udd51 \ud83e\udd55 \n\ud83d\ude97 \ud83d\ude91 \ud83d\ude92 \ud83d\ude9c \ud83e\uddbc \ud83d\udeb2 \ud83d\ude82 \ud83d\udee9 \ud83d\ude80 \ud83d\udef8 \ud83d\udef0 \ud83e\ude90 \ud83e\uddef \ud83e\uddf7  \ud83e\ude91 \ud83d\udece \u2602 \u26c4\n".replace(/\n/g,"").split(" ").map((e=>e.trim())).filter((e=>e)),pe=({userProfile:e,onUserProfileChange:t,usedEmojis:n})=>{const[o,l]=(0,r.useState)(ge),[a,i]=(0,r.useState)(!1);return(0,r.useEffect)((()=>{l(ge.filter((e=>!n.includes(e))))}),[n]),a?r.createElement(r.Fragment,null,r.createElement($,null,r.createElement(y,{style:{flexDirection:"row",flexWrap:"wrap"}},o.map((n=>r.createElement(v,{key:n,onPress:()=>{return r=n,i(!1),void t(Object.assign(Object.assign({},e),{emoji:r}));var r}},r.createElement(y,null,r.createElement(h,{style:{fontSize:32}},n)))))))):r.createElement(r.Fragment,null,r.createElement($,null,r.createElement(L,null,r.createElement(v,{onPress:()=>i(!0)},r.createElement(y,null,r.createElement(h,{style:{fontSize:32}},e.emoji))),r.createElement(ye,{userProfile:e,onNameChange:n=>t(Object.assign(Object.assign({},e),{name:n}))}))))},ye=({userProfile:e,onNameChange:t})=>{const[n,o]=(0,r.useState)(e.name||"Player"),[l,a]=(0,r.useState)(!1),i=()=>{t(n),a(!1)};return r.createElement(r.Fragment,null,r.createElement(H,{value:n,onChange:o,onSubmit:i,onFocus:()=>{o(""),a(!0)}}),l&&r.createElement(B,{onPress:i},"Set Name"))},he=e=>{const{clientState:t,meshState:n}=e.controller,{clientPlayer:o,role:l}=t.client;return r.createElement(r.Fragment,null,r.createElement(y,{key:o.clientKey,style:{padding:4,flexDirection:"row",alignItems:"center"}},"player"===l&&o?r.createElement(r.Fragment,null,r.createElement(y,{style:{width:36}},r.createElement(h,{style:{fontSize:24}},o.emoji)),r.createElement(y,null,r.createElement(h,{style:{fontSize:16}},o.name))):r.createElement(r.Fragment,null,r.createElement(y,null,r.createElement(h,{style:{fontSize:16}},l))),r.createElement(y,{style:{flex:1}}),r.createElement(y,null,r.createElement(h,{style:{fontSize:16}},(null===n||void 0===n?void 0:n.hostClientKey)===t.client.clientPlayer.clientKey?"\ud83d\udfe2":""))))},fe=e=>{var t,n,o,l;const a=null!==(n=null===(t=e.controller.meshState)||void 0===t?void 0:t.history.rounds.flatMap(((e,t)=>e.completed.map((e=>{var n;return{iRound:t,item:e,chainKey:null===(n=e.assignment)||void 0===n?void 0:n.chainKey}})))))&&void 0!==n?n:[],i=(0,P.dY)((0,P.sD)(a,(e=>{var t;return null!==(t=e.chainKey)&&void 0!==t?t:""}))).map((e=>({chain:e.key,items:e.value.sort(((e,t)=>e.iRound-t.iRound))})));return r.createElement(y,null,r.createElement(h,null,"Players"),r.createElement(me,{controller:e.controller}),r.createElement(h,null,"Rounds"),r.createElement(h,null,`${null!==(l=null===(o=e.controller.meshState)||void 0===o?void 0:o.history.rounds.length)&&void 0!==l?l:0}`),r.createElement(h,null,"Chains"),r.createElement(y,null,i.map(((e,t)=>r.createElement(y,{key:`${t}`,style:{margin:4,padding:4,background:"#444444"}},r.createElement(y,{style:{flexDirection:"row",alignItems:"center",flexWrap:"wrap"}},e.items.map((e=>r.createElement(y,{key:e.item.clientKey,style:{padding:4}},r.createElement(ve,{player:e.item}))))))))))},ve=e=>{var t,n;const o=e.player,{assignment:l}=e.player;return r.createElement(y,{style:{flexDirection:"column",alignItems:"center",width:104}},r.createElement(h,null,o.name),r.createElement(h,null,o.emoji),r.createElement(h,{style:{color:"#FFFF00",whiteSpace:"pre-wrap"}},"doodle"===(null===l||void 0===l?void 0:l.kind)&&null!==(t=null===l||void 0===l?void 0:l.prompt)&&void 0!==t?t:""),!!(null===l||void 0===l?void 0:l.doodle)&&r.createElement(le,{style:{width:104,height:104,color:"#FFFFFF",backgroundColor:"#000000"},drawing:i(l.doodle),shouldAnimate:!0,enableRedraw:!0}),r.createElement(h,{style:{color:"#FFFF00",whiteSpace:"pre-wrap"}},"describe"===(null===l||void 0===l?void 0:l.kind)&&null!==(n=null===l||void 0===l?void 0:l.prompt)&&void 0!==n?n:""))},be=e=>{var t,n;const{clientState:o,meshState:l}=e.controller,{clientKey:s}=o.client.clientPlayer,c=null===(t=null===l||void 0===l?void 0:l.players.find((e=>e.clientKey===s)))||void 0===t?void 0:t.assignment,[d,u]=(0,r.useState)("");if((0,r.useEffect)((()=>{u("")}),[c]),!c)return r.createElement(r.Fragment,null,r.createElement(y,{style:{padding:8}},r.createElement(h,null,"Please Wait Until Next Round")),r.createElement(fe,{controller:e.controller}));if("describe"===c.kind&&c.doodle){const t=()=>{c.prompt=d,e.controller.sendAssignment(c)};return r.createElement(r.Fragment,null,r.createElement(y,{style:{flexDirection:"column",alignItems:"center"}},r.createElement(h,{style:{fontSize:20,margin:8}},"Describe"),r.createElement(le,{style:{width:312,height:312,color:"#FFFFFF",backgroundColor:"#000000"},drawing:i(c.doodle),shouldAnimate:!0,enableRedraw:!0}),!c.prompt&&r.createElement(r.Fragment,null,r.createElement(h,{style:{fontSize:20,margin:8,color:"#FFFF00"}},"What is this?"),r.createElement(H,{value:d,onChange:u,onSubmit:t}),r.createElement(B,{onPress:t},"Done")),c.prompt&&r.createElement(r.Fragment,null,r.createElement(h,{style:{fontSize:20,margin:8,color:"#FFFF00"}},c.prompt),r.createElement(h,{style:{fontSize:20,margin:8,color:"#FFFF00"}},"Waiting for other players"),r.createElement(me,{controller:e.controller,hideInactive:!0}),r.createElement(y,{style:{padding:8}},r.createElement(b,{size:"large",color:"#FFFF00"})))))}return c.doodle?r.createElement(r.Fragment,null,r.createElement(y,{style:{flexDirection:"column",alignItems:"center"}},r.createElement(h,{style:{fontSize:20,margin:8}},"Draw"),r.createElement(le,{style:{width:312,height:312,color:"#FFFFFF",backgroundColor:"#000000"},drawing:i(c.doodle),shouldAnimate:!0,enableRedraw:!0}),r.createElement(h,{style:{fontSize:20,margin:8,color:"#FFFF00"}},"Waiting for other players"),r.createElement(me,{controller:e.controller,hideInactive:!0}),r.createElement(y,{style:{padding:8}},r.createElement(b,{size:"large",color:"#FFFF00"})))):r.createElement(r.Fragment,null,r.createElement(h,{style:{fontSize:20,margin:8}},"Draw"),r.createElement(de,{prompt:null!==(n=c.prompt)&&void 0!==n?n:"",onDone:t=>{c.doodle=a(t),e.controller.sendAssignment(c)}}))},we=(e,t)=>{const n=[],r=[],o={send:null},l=[],a=(e=>({connect:({channelKey:t})=>{const n=(0,P.Li)(),r=(0,P.Li)(),o=()=>{const o=new WebSocket(`${e.websocketsApiUrl}`);return o.addEventListener("open",(e=>{if(o!==a)return void o.close();r.onStateChange({connectionStatus:"opened"});const n={message:null,key:t};o.send(JSON.stringify(n))})),o.addEventListener("close",(e=>{o===a?(r.onStateChange({connectionStatus:"closed"}),i()):o.close()})),o.addEventListener("error",(e=>{o===a?(r.onStateChange({connectionStatus:"error",error:{message:"Websocket Error",error:e}}),i()):o.close()})),o.addEventListener("message",(e=>{if(o!==a)return void o.close();const r=JSON.parse(e.data);r.key===t&&r.message&&n.onStateChange(r.message)})),o};let l=!1,a=o();const i=()=>{l||setTimeout((()=>{a=o()}),50)};return{send:e=>{if(!a||a.readyState!==WebSocket.OPEN)throw new P.gz("Websocket is not open");const n={message:e,key:t};a.send(JSON.stringify(n))},isConnected:()=>(null===a||void 0===a?void 0:a.readyState)===WebSocket.OPEN,subscribeMessages:n.subscribe,subscribeConnectionEvents:r.subscribe,close:()=>{l=!0,null===a||void 0===a||a.close(),a=null}}}}))({websocketsApiUrl:e.websocketsApiUrl}).connect({channelKey:e.channelKey}),i=a.subscribeMessages((e=>{t(e),n.push(Object.assign(Object.assign({},e),{_r:Date.now()}))})),s=a.subscribeConnectionEvents((e=>{o.send=a.isConnected()?a.send:null,r.push(e)})),c=setInterval((()=>d()),250),d=()=>{if(!o.send)return;const e=l.splice(0,l.length);for(const t of e)o.send(t)};return{send:e=>{o.send?(d(),o.send(e)):l.push(e)},unsubscribe:()=>{clearInterval(c),o.send=null,i.unsubscribe(),s.unsubscribe(),a.close()},history:{messages:n,events:r}}},Ee=({channelKey:e,initialState:t,reduceState:n,reduceClientsState:r,websocketsApiConfig:o})=>{var l;const a="_webMeshClientKey",i=null!==(l=localStorage.getItem(a))&&void 0!==l?l:`${Date.now()}-${Math.floor(999999*Math.random())}`;localStorage.setItem(a,i);const s=(0,P.Li)(),c={meshState:t,meshMetaData:{clients:[],firstMessageTimestamp:0,lastMessageTimestamp:0}},d=[];let u=setTimeout((()=>{}),0);const m=we({websocketsApiUrl:o.websocketsApiUrl,channelKey:`wm_${e}`},(e=>{if("close"===e.kind)return clearTimeout(u),c.meshMetaData.clients=c.meshMetaData.clients.filter((t=>t.key!==e.c)),c.meshState=r(c.meshState,c.meshMetaData.clients),void s.onStateChange(c.meshState);if((e=>{const t=[...c.meshMetaData.clients];c.meshMetaData.clients=c.meshMetaData.clients.filter((t=>t.key!==e.c)),c.meshMetaData.clients.push({key:e.c,lastActivityTimestamp:e.t}),c.meshMetaData.clients.sort(((e,t)=>-(e.lastActivityTimestamp-t.lastActivityTimestamp))),t.map((e=>e.key)).join(";")!==c.meshMetaData.clients.map((e=>e.key)).join(";")&&(c.meshState=r(c.meshState,c.meshMetaData.clients),s.onStateChange(c.meshState))})(e),"pong"===e.kind)return clearTimeout(null!==h&&void 0!==h?h:0),void(h=null);if("ping"===e.kind)return clearTimeout(null!==h&&void 0!==h?h:0),h=null,void(e.clientKeys.includes(i)&&setTimeout(y));if("drop"===e.kind)return clearTimeout(null!==h&&void 0!==h?h:0),h=null,c.meshMetaData.clients=c.meshMetaData.clients.filter((t=>!e.clientKeys.some((e=>e===t.key)))),c.meshState=r(c.meshState,c.meshMetaData.clients),void s.onStateChange(c.meshState);if("join"!==e.kind){if("sync"===e.kind){if(e.c===i)return;if(c.meshMetaData.firstMessageTimestamp&&c.meshMetaData.firstMessageTimestamp<e.state.meshMetaData.firstMessageTimestamp)return void(u=setTimeout(p,1e4));clearTimeout(u),c.meshMetaData.firstMessageTimestamp=e.state.meshMetaData.firstMessageTimestamp,c.meshMetaData.lastMessageTimestamp=e.state.meshMetaData.lastMessageTimestamp,c.meshMetaData.clients=(0,P.Xq)([...c.meshMetaData.clients,...e.state.meshMetaData.clients],(e=>e.key)),c.meshState=e.state.meshState;const t=d.filter((e=>e.t>c.meshMetaData.lastMessageTimestamp));for(const e of t){if("message"!==e.kind)return;c.meshState=n(c.meshState,e.message),c.meshMetaData.lastMessageTimestamp=e.t}return c.meshState=r(c.meshState,c.meshMetaData.clients),void s.onStateChange(c.meshState)}"message"===e.kind&&(d.push(e),c.meshMetaData.firstMessageTimestamp||(c.meshMetaData.firstMessageTimestamp=e.t),c.meshMetaData.lastMessageTimestamp=e.t,c.meshState=n(c.meshState,e.message),s.onStateChange(c.meshState))}else{if(clearTimeout(u),e.c===i)return;const t=c.meshMetaData.clients.findIndex((e=>e.key===i))-1;u=setTimeout(p,t>=0?2e3*t:1e4)}})),g=e=>{m.send(Object.assign(Object.assign({},e),{c:i,t:Date.now()}))},p=()=>{c.meshMetaData.clients=c.meshMetaData.clients.filter((e=>e.key!==i)),c.meshMetaData.clients.unshift({key:i,lastActivityTimestamp:Date.now()}),g({kind:"sync",state:c})},y=()=>{g({kind:"pong"})};let h=null;const f=setInterval((()=>{if(h)return;if(c.meshMetaData.clients.filter((e=>Date.now()>45e3+e.lastActivityTimestamp)).length>0){const e=c.meshMetaData.clients.findIndex((e=>e.key===i));return void(h=setTimeout((()=>{h=null;const e=c.meshMetaData.clients.filter((e=>Date.now()>45e3+e.lastActivityTimestamp));e.length<=0||g({kind:"drop",clientKeys:e.map((e=>e.key))})}),5e3*e))}if(c.meshMetaData.clients.filter((e=>Date.now()>3e4+e.lastActivityTimestamp)).length<=0)return;const e=c.meshMetaData.clients.findIndex((e=>e.key===i));h=setTimeout((()=>{h=null;const e=c.meshMetaData.clients.filter((e=>Date.now()>3e4+e.lastActivityTimestamp));e.length<=0||g({kind:"ping",clientKeys:e.map((e=>e.key))})}),5e3*e)}),5e3);let v=!1;return g({kind:"join"}),{_webSocket:{history:m.history},clientKey:i,sendMessage:e=>{if(v)throw new P.gz("The connection is closed");g({kind:"message",message:e})},subscribe:s.subscribe,close:()=>{v||(v=!0,g({kind:"close"}),m.unsubscribe(),clearInterval(f))}}},Se=()=>{const e="_DoodleGameClient";return{clientStorage:{load:()=>{var t;try{return JSON.parse(null!==(t=localStorage.getItem(e))&&void 0!==t?t:"NULL!{}")}catch(n){return null}},save:t=>{localStorage.setItem(e,JSON.stringify(t))}}}},ke=()=>{const e=(e=>{const t={},n=("?"===e[0]?e.substr(1):e).split("&");for(const r of n){const e=r.split("=");t[decodeURIComponent(e[0])]=decodeURIComponent(e[1]||"")}return t})(window.location.search);var t;return{client:{_query:e,room:(t=e.room,null!==t&&void 0!==t?t:"UnknownRoom"),role:(e=>{switch(e){case"debug":return"debug";case"viewer":return"viewer";default:return"player"}})(e.role),clientPlayer:{isActive:!0,clientKey:"",name:"",emoji:"\ud83d\udc64",isReady:!1}}}},xe=(e,t,n)=>{var r,o,l;const a="Choose Your Own Word",i=()=>({kind:"doodle",prompt:a,chainKey:`${Date.now()}-${Math.floor(999999*Math.random())}`}),s=e.players.find((e=>e.clientKey===t));if(!s)return i();const c=e.history.rounds.flatMap((e=>e.completed)).filter((e=>e.clientKey===s.clientKey)),d=null!==(r=c[c.length-1])&&void 0!==r?r:void 0,u=null!==(l=null===(o=null===d||void 0===d?void 0:d.assignment)||void 0===o?void 0:o.kind)&&void 0!==l?l:"doodle",m=new Set(e.history.rounds.flatMap((e=>e.completed)).filter((e=>e.clientKey===s.clientKey)).filter((e=>{var t;return(null===(t=e.assignment)||void 0===t?void 0:t.prompt)!==a})).map((e=>{var t,n,r;return null!==(r=null===(n=null===(t=e.assignment)||void 0===t?void 0:t.prompt)||void 0===n?void 0:n.toLowerCase().trim())&&void 0!==r?r:""}))),g=n.findIndex((e=>{var t,n;return!m.has(null!==(n=null===(t=e.prompt)||void 0===t?void 0:t.toLowerCase().trim())&&void 0!==n?n:"")&&e.kind===u}));if(g<0)return i();const p=n.splice(g,1)[0],y=Object.assign({},p);return"doodle"===y.kind?(y.kind="describe",y.prompt=void 0):(y.kind="doodle",y.doodle=void 0),y},Fe=(e,t)=>{var n;if(console.log("reduceState",{message:t}),"setHost"===t.kind)return e.hostClientKey=t.hostClientKey,e;if("setPlayer"===t.kind){let n=e.players.find((e=>e.clientKey===t.clientPlayer.clientKey));return n||(n=Object.assign(Object.assign({},t.clientPlayer),{isActive:!0}),e.players.push(n)),n.name=t.clientPlayer.name,n.emoji=t.clientPlayer.emoji,n.isReady=t.clientPlayer.isReady,e}if("assign"===t.kind)return e.players=t.players,t.lastRound&&t.lastRound.completed.length>0&&(e.history.rounds.find((e=>{var n;return e.roundKey===(null===(n=t.lastRound)||void 0===n?void 0:n.roundKey)}))||e.history.rounds.push(t.lastRound)),e;if("completeAssignment"===t.kind){const r=null===(n=e.players.find((e=>e.clientKey===t.playerAssignment.clientKey)))||void 0===n?void 0:n.assignment;return r?(r.prompt=t.playerAssignment.prompt,r.doodle=t.playerAssignment.doodle,e):e}return e},De=(e,t)=>(console.log("reduceClientsState",{clients:t}),e.players.forEach((e=>{e.isActive=!!t.find((t=>t.key===e.clientKey))})),e.clients=(0,P.EB)([...e.clients,...t].map((e=>e.key))).map((e=>({key:e,isActive:!!t.find((t=>t.key===e))}))),e),_e=e=>{var t,n,o,l;const a=(0,r.useRef)(ke()).current,[s,d]=(0,r.useState)(!0),[u,m]=(0,r.useState)(0),g=()=>{m((e=>e+1))},p=(0,r.useRef)(null),y=(0,r.useRef)(null),h=(0,r.useRef)(null);(0,r.useEffect)((()=>{const t=Ee({channelKey:`doodle_${a.client.room}`,initialState:{hostClientKey:"",clients:[],players:[],history:{rounds:[]}},reduceState:Fe,reduceClientsState:De,websocketsApiConfig:e}),n=t.subscribe((e=>{p.current=e,g()}));h.current={history:t._webSocket.history},y.current=t.sendMessage,(()=>{const{clientStorage:e}=Se(),t=e.load();t&&(a.client.clientPlayer={clientKey:"",name:t.clientPlayer.name,emoji:t.clientPlayer.emoji,isReady:!1,isActive:!0}),g()})(),a.client.clientPlayer.clientKey=t.clientKey;const r=setInterval((()=>{var n;const r=p.current;if(!r)return;(null===(n=r.clients.find((e=>e.key===r.hostClientKey)))||void 0===n?void 0:n.isActive)?r.hostClientKey===t.clientKey&&((e,t,n)=>{if(t.players.filter((e=>e.isActive&&e.isReady)).length<=0)return;const r=(0,P.dY)((0,P.sD)(t.history.rounds.flatMap((e=>e.completed)).map((e=>e.assignment)).filter((e=>e)).map((e=>e)),(e=>{var t;return null!==(t=null===e||void 0===e?void 0:e.chainKey)&&void 0!==t?t:""}))).map((e=>e.value[e.value.length-1]));if(t.players.some((e=>e.isActive&&e.isReady&&e.assignment&&(!e.assignment.doodle||!e.assignment.prompt)))){const e=t.players.filter((e=>!e.assignment));return e.length>0?(e.forEach((e=>{e.assignment=xe(t,e.clientKey,r)})),void n({kind:"assign",players:t.players,lastRound:void 0})):void 0}const o=[...t.players.filter((e=>e.assignment&&e.assignment.doodle&&e.assignment.prompt&&i(e.assignment.doodle).segments.length>0)).map((e=>Object.assign(Object.assign({},e),{assignment:e.assignment?Object.assign({},e.assignment):void 0})))],l={roundKey:`${Date.now()}`,completed:o};t.history.rounds.push(l);for(let a=0;a<t.players.length;a++)t.players[a].assignment=xe(t,t.players[a].clientKey,r);n({kind:"assign",players:t.players,lastRound:l}),setTimeout((async()=>{const n=X(e),r=(await n.createUploadUrl({prefix:`${c.doodlePartyDrawingsPrefix}/${Date.now()}`})).uploadUrl,o=Q(r);await o.uploadData({history:t.history})}))})(e,r,t.sendMessage):t.sendMessage({kind:"setHost",hostClientKey:t.clientKey})}),3e3+Math.floor(3e3*Math.random()));return d(!1),()=>{n.unsubscribe(),t.close(),clearInterval(r)}}),[]);return{loading:s,renderId:u,clientState:a,meshState:p.current,setClientPlayer:e=>{const{clientStorage:t}=Se();a.client.clientPlayer=Object.assign(Object.assign({},a.client.clientPlayer),e),t.save({clientPlayer:a.client.clientPlayer}),(()=>{var e;"player"===a.client.role&&(null===(e=y.current)||void 0===e||e.call(y,{kind:"setPlayer",clientPlayer:a.client.clientPlayer}))})(),g()},sendAssignment:e=>{var t;"player"===a.client.role&&(null===(t=y.current)||void 0===t||t.call(y,{kind:"completeAssignment",playerAssignment:Object.assign(Object.assign({},e),{clientKey:a.client.clientPlayer.clientKey})}))},_messages:null!==(n=null===(t=h.current)||void 0===t?void 0:t.history.messages)&&void 0!==n?n:[],_events:null!==(l=null===(o=h.current)||void 0===o?void 0:o.history.events)&&void 0!==l?l:[]}},Me=({config:e})=>{const t=_e(e);return r.createElement(r.Fragment,null,r.createElement(he,{controller:t}),r.createElement(je,{controller:t}))},je=({controller:e})=>{const[t,n]=(0,r.useState)("profile"),o=()=>{n("play")};return e.loading?r.createElement(b,{size:"large",color:"#FFFF00"}):"debug"===e.clientState.client.role?r.createElement(Ce,{controller:e}):"viewer"===e.clientState.client.role?r.createElement(fe,{controller:e}):"profile"===t?r.createElement(ue,{controller:e,onDone:o}):r.createElement(be,{controller:e})},Ce=e=>{var t;const{clientState:n,meshState:o,_events:l,_messages:a}=e.controller,[i,s]=(0,r.useState)(0);return(0,r.useEffect)((()=>{const e=setInterval((()=>{s((e=>e+1))}),1e3);return()=>{clearInterval(e)}}),[]),r.createElement(r.Fragment,null,r.createElement(fe,{controller:e.controller}),r.createElement(y,{style:{marginTop:64,background:"#555555"}},r.createElement(h,{style:{fontSize:20}},"Debug"),r.createElement(y,null,r.createElement(h,null,`Query: ${JSON.stringify(n.client._query)}`),r.createElement(h,null,`Room: ${n.client.room}`),r.createElement(h,null,`Role: ${n.client.role}`)),r.createElement(y,{style:{padding:4}},r.createElement(h,{style:{whiteSpace:"pre-wrap",fontSize:18}},"Host"),r.createElement(h,{style:{whiteSpace:"pre-wrap",fontSize:14}},`'${null!==(t=null===o||void 0===o?void 0:o.hostClientKey)&&void 0!==t?t:""}'`),r.createElement(h,{style:{whiteSpace:"pre-wrap",fontSize:18}},"Players"),null===o||void 0===o?void 0:o.players.map(((e,t)=>r.createElement(h,{key:t,style:{whiteSpace:"pre-wrap",fontSize:14}},JSON.stringify(e))))),r.createElement(h,{style:{fontSize:20}},"Web Sockets"),r.createElement(y,null,r.createElement(y,{style:{padding:4}},r.createElement(h,{style:{whiteSpace:"pre-wrap",fontSize:18}},"Events"),l.map(((e,t)=>r.createElement(h,{key:t,style:{whiteSpace:"pre-wrap",fontSize:14}},JSON.stringify(e))))),r.createElement(y,{style:{padding:4}},r.createElement(h,{style:{whiteSpace:"pre-wrap",fontSize:18}},"Messages"),a.map(((e,t)=>r.createElement(h,{key:t,style:{whiteSpace:"pre-wrap",fontSize:14}},`${e.t} ${e._r-e.t}: ${JSON.stringify(e)}`)))))))}}}]);